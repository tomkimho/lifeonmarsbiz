<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BizPlanner - Smart Business Planner</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0F172A">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“…</text></svg>">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; }
    body { font-family: 'Noto Sans KR', -apple-system, sans-serif; overflow-x: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;



// â•â•â• Firebase Cloud Sync â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBq3KuweKLuND6qPrK-W2zG-ifMouZ4gSo",
  authDomain: "bizplanner-2592b.firebaseapp.com",
  projectId: "bizplanner-2592b",
  storageBucket: "bizplanner-2592b.firebasestorage.app",
  messagingSenderId: "677571477287",
  appId: "1:677571477287:web:8fa58493c4ecc1d9d87302"
};

// Validate Firebase config properly
function isFirebaseConfigValid(){
  const c=FIREBASE_CONFIG;
  if(!c.apiKey||!c.projectId||!c.appId) return false;
  if(c.apiKey.includes("PASTE_YOUR")||c.apiKey.includes("ë³¸ì¸")||c.apiKey.includes("...")) return false;
  if(c.projectId.includes("PASTE_YOUR")||c.projectId.includes("xxxxx")) return false;
  if(c.appId.includes("PASTE_YOUR")) return false;
  if(c.apiKey.length<20) return false;
  return true;
}

let fbReady = false;
try {
  if (isFirebaseConfigValid()) {
    firebase.initializeApp(FIREBASE_CONFIG);
    fbReady = true;
    console.log("Firebase initialized successfully");
  } else {
    console.log("Firebase not configured - running in local mode");
  }
} catch(e) { console.warn("Firebase init error:", e); }

const fbAuth = fbReady ? firebase.auth() : null;
const fbDb = fbReady ? firebase.firestore() : null;
const fbGoogle = fbReady ? new firebase.auth.GoogleAuthProvider() : null;

async function cloudLoad(uid) {
  if (!fbDb) return null;
  try { const doc = await fbDb.collection('users').doc(uid).get(); return doc.exists ? doc.data() : null; }
  catch(e) { console.error("Cloud load:",e); return null; }
}
async function cloudSaveAll(uid, data) {
  if (!fbDb) return;
  try { await fbDb.collection('users').doc(uid).set({ ...data, lastUpdated: new Date().toISOString() }, { merge: true }); }
  catch(e) { console.error("Cloud save:",e); }
}

// â”€â”€â”€ Login Screen â”€â”€â”€
function LoginScreen({onLogin,onSkip}){
  return(
    <div style={{minHeight:"100vh",background:"linear-gradient(135deg,#0F172A 0%,#1E3A5F 50%,#0F172A 100%)",display:"flex",justifyContent:"center",alignItems:"center",fontFamily:"'Noto Sans KR',sans-serif",padding:20}}>
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
      <div style={{textAlign:"center",maxWidth:360,width:"100%"}}>
        <div style={{width:80,height:80,borderRadius:20,background:"linear-gradient(135deg,#3B82F6,#8B5CF6)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:40,margin:"0 auto 20px",boxShadow:"0 8px 32px rgba(59,130,246,0.4)"}}>ğŸ“…</div>
        <h1 style={{color:"#fff",fontSize:28,fontWeight:800,marginBottom:4,letterSpacing:"-0.5px"}}>BizPlanner</h1>
        <p style={{color:"#64748B",fontSize:12,marginBottom:40,letterSpacing:2}}>SMART BUSINESS PLANNER</p>
        <button onClick={onLogin} style={{display:"flex",alignItems:"center",gap:12,margin:"0 auto",padding:"14px 32px",borderRadius:12,border:"none",background:"#fff",color:"#334155",fontSize:15,fontWeight:600,cursor:"pointer",boxShadow:"0 4px 24px rgba(0,0,0,0.3)",transition:"transform 0.15s",width:"100%",maxWidth:280,justifyContent:"center"}}
          onMouseEnter={e=>e.currentTarget.style.transform="scale(1.02)"} onMouseLeave={e=>e.currentTarget.style.transform="scale(1)"}>
          <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Googleë¡œ ë¡œê·¸ì¸
        </button>
        <p style={{color:"#475569",fontSize:11,marginTop:28,lineHeight:1.7}}>ë¡œê·¸ì¸í•˜ë©´ íœ´ëŒ€í°ê³¼ PCì—ì„œ<br/>ê°™ì€ ì¼ì •ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        {onSkip&&<button onClick={onSkip} style={{border:"none",background:"none",color:"#64748B",fontSize:12,cursor:"pointer",marginTop:16,padding:"8px 16px",textDecoration:"underline"}}>ë¡œê·¸ì¸ ì—†ì´ ì‚¬ìš© â†’</button>}
      </div>
    </div>
  );
}

// â”€â”€â”€ Constants â”€â”€â”€
const DAYS_KR = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
const MONTHS_KR = ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
const PRI = { high:{bg:"#FEE2E2",text:"#DC2626",dot:"#EF4444",label:"ìƒ"}, medium:{bg:"#FFF7ED",text:"#EA580C",dot:"#F97316",label:"ì¤‘"}, low:{bg:"#EFF6FF",text:"#2563EB",dot:"#3B82F6",label:"í•˜"} };
const CAT = { meeting:{i:"ğŸ¤",l:"ë¯¸íŒ…"}, call:{i:"ğŸ“",l:"í†µí™”"}, task:{i:"ğŸ“‹",l:"ì—…ë¬´"}, travel:{i:"âœˆï¸",l:"ì¶œì¥"}, personal:{i:"ğŸ‘¤",l:"ê°œì¸"}, deadline:{i:"â°",l:"ë§ˆê°"} };
const MEMO_T = {
  free:{icon:"ğŸ“",label:"ììœ  ë©”ëª¨",color:"#6366F1"}, schedule:{icon:"ğŸ“…",label:"ì¼ì • ë©”ëª¨",color:"#0EA5E9"},
  meeting:{icon:"ğŸ¤",label:"íšŒì˜ë¡",color:"#10B981"}, idea:{icon:"ğŸ’¡",label:"ì•„ì´ë””ì–´",color:"#F59E0B"}, diary:{icon:"ğŸ“”",label:"ì¼ê¸°",color:"#EC4899"},
};
const ALARM_OPTS = [{v:0,l:"ì •ì‹œ"},{v:5,l:"5ë¶„ ì „"},{v:10,l:"10ë¶„ ì „"},{v:15,l:"15ë¶„ ì „"},{v:30,l:"30ë¶„ ì „"},{v:60,l:"1ì‹œê°„ ì „"},{v:1440,l:"1ì¼ ì „"}];
const TODO_CATS = ["ì—…ë¬´","ê°œì¸","í”„ë¡œì íŠ¸","ì—°êµ¬","ê¸°íƒ€"];
const ROUTINES = [
  {id:"exercise",label:"ìš´ë™ 30ë¶„ ì´ìƒ",icon:"ğŸ’ª",short:"ìš´ë™"},
  {id:"english1",label:"ì˜ì–´ê³µë¶€ 1",icon:"ğŸ“—",short:"ì˜ì–´1"},
  {id:"english2",label:"ì˜ì–´ê³µë¶€ 2",icon:"ğŸ“˜",short:"ì˜ì–´2"},
  {id:"reading",label:"ë…ì„œ 30ë¶„",icon:"ğŸ“š",short:"ë…ì„œ"},
  {id:"writing",label:"ê¸€ì“°ê¸° 1ê±´",icon:"âœï¸",short:"ê¸€ì“°ê¸°"},
  {id:"networking",label:"ë„¤íŠ¸ì›Œí‚¹ ë©”ì‹œì§€ 3ê±´+",icon:"ğŸ’¬",short:"ë„¤íŠ¸ì›Œí‚¹"},
];
const NEWS_API = "https://lifeonmarsbiz.vercel.app/api/news";
const PUBMED_BASE = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils";
const DOORAY_API = "https://lifeonmarsbiz.vercel.app/api/dooray";
const uid = () => Date.now().toString(36)+Math.random().toString(36).substr(2,9);
const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const pD = s => { const[y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); };
const dBtw = (a,b) => Math.floor((pD(b)-pD(a))/864e5);
const TODAY = fmt(new Date());

// â”€â”€â”€ Storage â”€â”€â”€
function ld(k,fb){try{const r=localStorage.getItem(k);return r?JSON.parse(r):fb;}catch{return fb;}}
function sv(k,d){try{localStorage.setItem(k,JSON.stringify(d));}catch(e){console.error(e);}}

// â”€â”€â”€ Dooray API helpers â”€â”€â”€
async function doorayFetch(action, params={}){
  try {
    const qs = new URLSearchParams({action,...params}).toString();
    const r = await fetch(`${DOORAY_API}?${qs}`);
    if(!r.ok) return null;
    return await r.json();
  } catch(e){ console.error("Dooray fetch error:",e); return null; }
}
async function doorayPost(action, body){
  try {
    const r = await fetch(`${DOORAY_API}?action=${action}`, {
      method: action==="delete"?"DELETE":action==="update"?"PUT":"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    return await r.json();
  } catch(e){ console.error("Dooray post error:",e); return null; }
}

// â”€â”€â”€ Notification Helper â”€â”€â”€
function requestNotifPermission(){try{if("Notification"in window&&Notification.permission==="default")Notification.requestPermission();}catch{}}
function showNotif(title,body){try{if("Notification"in window&&Notification.permission==="granted")new Notification(title,{body,icon:"ğŸ“…"});}catch{}}

// â”€â”€â”€ Confirm Dialog â”€â”€â”€
function ConfirmDialog({message,onConfirm,onCancel}){
  return(
    <div style={modalOverlay} onClick={onCancel}>
      <div style={{background:"#fff",borderRadius:16,padding:20,width:"100%",maxWidth:340,boxShadow:"0 20px 60px rgba(0,0,0,0.25)"}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:15,fontWeight:600,color:"#1E293B",marginBottom:6,lineHeight:1.5}}>âš ï¸ í™•ì¸</div>
        <div style={{fontSize:14,color:"#64748B",marginBottom:20,lineHeight:1.6,wordBreak:"keep-all"}}>{message}</div>
        <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
          <button onClick={onCancel} style={{...btnS,background:"#F1F5F9",color:"#64748B"}}>ì·¨ì†Œ</button>
          <button onClick={onConfirm} style={{...btnS,background:"#DC2626",color:"#fff"}}>ì‚­ì œ</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Contact Picker â”€â”€â”€
function ContactPicker({contacts,value,onChange,onAddNew}){
  const[open,setOpen]=useState(false);const[q,setQ]=useState("");const ref=useRef(null);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);
  const fl=contacts.filter(c=>c.name.toLowerCase().includes(q.toLowerCase())||c.company?.toLowerCase().includes(q.toLowerCase()));
  return(
    <div ref={ref} style={{position:"relative"}}>
      <input value={value} onChange={e=>onChange(e.target.value)} onFocus={()=>setOpen(true)} placeholder="ğŸ‘¥ ì°¸ì„ì" style={inpS}/>
      {open&&<div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",borderRadius:12,boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:50,maxHeight:200,overflow:"auto",marginTop:4,border:"1px solid #E2E8F0"}}>
        <div style={{padding:"6px 8px",borderBottom:"1px solid #F1F5F9"}}><input value={q} onChange={e=>setQ(e.target.value)} placeholder="ê²€ìƒ‰..." style={{...inpS,padding:"6px 10px",fontSize:13}}/></div>
        {fl.map(c=><div key={c.id} onClick={()=>{onChange(value?value+", "+c.name:c.name);setOpen(false);setQ("");}}
          style={{padding:"8px 12px",cursor:"pointer",borderBottom:"1px solid #F8FAFC",fontSize:13}}
          onMouseEnter={e=>e.currentTarget.style.background="#F1F5F9"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
          <div style={{fontWeight:600,color:"#1E293B"}}>{c.name}</div>
          <div style={{fontSize:11,color:"#94A3B8"}}>{c.company}{c.phone?` Â· ${c.phone}`:""}</div>
        </div>)}
        <div onClick={()=>{onAddNew();setOpen(false);}} style={{padding:"8px 12px",cursor:"pointer",color:"#3B82F6",fontWeight:600,fontSize:13,borderTop:"1px solid #E2E8F0"}}>+ ìƒˆ ì—°ë½ì²˜ ì¶”ê°€</div>
      </div>}
    </div>
  );
}

// â”€â”€â”€ Company Autocomplete â”€â”€â”€
function CompanyAC({contacts,value,onChange}){
  const[open,setOpen]=useState(false);
  const cos=[...new Set(contacts.map(c=>c.company).filter(Boolean))];
  const fl=cos.filter(c=>c.toLowerCase().includes(value.toLowerCase()));
  return(
    <div style={{position:"relative"}}>
      <input value={value} onChange={e=>{onChange(e.target.value);setOpen(true);}} onFocus={()=>setOpen(true)} onBlur={()=>setTimeout(()=>setOpen(false),200)} placeholder="ğŸ¢ íšŒì‚¬ëª…" style={inpS}/>
      {open&&fl.length>0&&value&&<div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",borderRadius:8,boxShadow:"0 4px 16px rgba(0,0,0,0.12)",zIndex:40,maxHeight:140,overflow:"auto",marginTop:2}}>
        {fl.map(c=><div key={c} onClick={()=>{onChange(c);setOpen(false);}} style={{padding:"8px 14px",cursor:"pointer",fontSize:13,color:"#334155"}}
          onMouseEnter={e=>e.currentTarget.style.background="#F1F5F9"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>ğŸ¢ {c}</div>)}
      </div>}
    </div>
  );
}

// â”€â”€â”€ Countdown Alarm â”€â”€â”€
function CountdownAlarm({events}){
  const[now,setNow]=useState(new Date());
  useEffect(()=>{const t=setInterval(()=>setNow(new Date()),1000);return()=>clearInterval(t);},[]);
  const up=events.filter(e=>e.alarm!=null&&e.alarm>=0&&e.date&&e.time).map(e=>{
    const[h,m]=e.time.split(":").map(Number);const et=new Date(pD(e.date));et.setHours(h,m,0,0);
    const at=new Date(et.getTime()-(e.alarm||0)*60000);const diff=at-now;return{...e,diff,et,at};
  }).filter(e=>e.diff>-300000&&e.diff<864e5*2).sort((a,b)=>a.diff-b.diff).slice(0,3);
  useEffect(()=>{up.forEach(e=>{if(e.diff<=0&&e.diff>-2000)showNotif(`â° ${e.title}`,`${e.date} ${e.time}`);});},[now]);
  if(!up.length)return null;
  const fmtCD=ms=>{if(ms<=0)return"ì§€ê¸ˆ!";const h=Math.floor(ms/36e5),m=Math.floor(ms%36e5/6e4),s=Math.floor(ms%6e4/1e3);return h>0?`${h}ì‹œê°„ ${m}ë¶„`:m>0?`${m}ë¶„ ${s}ì´ˆ`:`${s}ì´ˆ`;};
  return(
    <div style={{background:"linear-gradient(135deg,#0F172A,#1E3A5F)",borderRadius:14,padding:"12px 14px",marginBottom:14}}>
      <div style={{fontSize:10,fontWeight:700,color:"#94A3B8",marginBottom:8,letterSpacing:1.5}}>â° COUNTDOWN</div>
      <div style={{display:"flex",flexDirection:"column",gap:6}}>
        {up.map(e=><div key={e.id} style={{display:"flex",alignItems:"center",gap:8,background:"rgba(255,255,255,0.06)",borderRadius:10,padding:"8px 10px"}}>
          <span style={{fontSize:16}}>{CAT[e.category]?.i||"ğŸ“…"}</span>
          <div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,color:"#F1F5F9",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{e.title}</div><div style={{fontSize:10,color:"#94A3B8"}}>{e.date} {e.time}</div></div>
          <div style={{background:e.diff<=0?"#EF4444":e.diff<6e5?"#F97316":"#3B82F6",color:"#fff",padding:"3px 8px",borderRadius:20,fontSize:11,fontWeight:700,minWidth:50,textAlign:"center",flexShrink:0}}>{fmtCD(e.diff)}</div>
        </div>)}
      </div>
    </div>
  );
}

// â”€â”€â”€ Dashboard Summary â”€â”€â”€
function Dashboard({events,todos}){
  const todayEvs=events.filter(e=>e.date===TODAY||(e.endDate&&e.date<=TODAY&&e.endDate>=TODAY)).length;
  const urgentTodos=todos.filter(t=>!t.completed&&t.priority==="high").length;
  const overdueTodos=todos.filter(t=>!t.completed&&t.dueDate&&t.dueDate<TODAY).length;
  const weekEvents=events.filter(e=>{const d=dBtw(TODAY,e.date);return d>=0&&d<=7;}).length;
  const items=[
    {icon:"ğŸ“…",label:"ì˜¤ëŠ˜",value:todayEvs,color:"#3B82F6",bg:"#EFF6FF"},
    {icon:"ğŸ“†",label:"ì´ë²ˆ ì£¼",value:weekEvents,color:"#8B5CF6",bg:"#F5F3FF"},
    {icon:"ğŸ”¥",label:"ê¸´ê¸‰",value:urgentTodos,color:"#EF4444",bg:"#FEF2F2"},
    {icon:"âš ï¸",label:"ì´ˆê³¼",value:overdueTodos,color:"#F97316",bg:"#FFF7ED"},
  ];
  return(
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6,marginBottom:14}}>
      {items.map(it=><div key={it.label} style={{background:it.bg,borderRadius:10,padding:"10px 4px",textAlign:"center"}}>
        <div style={{fontSize:14}}>{it.icon}</div>
        <div style={{fontSize:18,fontWeight:800,color:it.color,margin:"1px 0"}}>{it.value}</div>
        <div style={{fontSize:9,color:"#64748B",fontWeight:600}}>{it.label}</div>
      </div>)}
    </div>
  );
}

// â”€â”€â”€ Share Modal â”€â”€â”€
function ShareModal({item,onClose}){
  const[copied,setCopied]=useState(false);const[copiedContent,setCopiedContent]=useState(false);
  const txt=`[BizPlanner] ${item.title||"ê³µìœ "}\n${item.date?`ğŸ“… ${item.date}`:""}${item.time?` â° ${item.time}`:""}\n${item.location?`ğŸ“ ${item.location}\n`:""}${item.attendees?`ğŸ‘¥ ${item.attendees}\n`:""}${item.memo||item.content||item.decisions||""}`.trim();
  const copy=async(t,setter)=>{try{await navigator.clipboard.writeText(t);setter(true);setTimeout(()=>setter(false),2000);}catch{}};
  const opts=[
    {icon:"ğŸ’¬",label:"ì¹´ì¹´ì˜¤í†¡",color:"#FEE500",tc:"#3C1E1E",action:()=>{}},
    {icon:"ğŸ“¨",label:"ë‘ë ˆì´",color:"#3E6FE0",tc:"#fff",action:()=>{copy(txt,setCopiedContent);}},
    {icon:"ğŸ“±",label:"ë¬¸ì",color:"#4CAF50",tc:"#fff",action:()=>window.open(`sms:?body=${encodeURIComponent(txt)}`)},
    {icon:"ğŸ“§",label:"ì´ë©”ì¼",color:"#EA4335",tc:"#fff",action:()=>window.open(`mailto:?subject=${encodeURIComponent(item.title||"BizPlanner")}&body=${encodeURIComponent(txt)}`)},
  ];
  return(
    <div style={modalOverlay} onClick={onClose}><div style={{...modalCont,maxWidth:380}} onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h3 style={{margin:0,fontSize:17,fontWeight:700,color:"#1E293B"}}>ê³µìœ í•˜ê¸°</h3><button onClick={onClose} style={closeS}>âœ•</button></div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:14}}>
        {opts.map(o=><button key={o.label} onClick={o.action} style={{padding:"12px 8px",borderRadius:10,border:"none",background:o.color,color:o.tc,fontWeight:700,fontSize:13,cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
          <span style={{fontSize:20}}>{o.icon}</span>{o.label}</button>)}
      </div>
      <div style={{background:"#F8FAFC",borderRadius:10,padding:10}}>
        <pre style={{fontSize:11,color:"#475569",whiteSpace:"pre-wrap",margin:"0 0 6px",lineHeight:1.5,maxHeight:80,overflow:"auto"}}>{txt}</pre>
        <button onClick={()=>copy(txt,setCopiedContent)} style={{...btnS,padding:"6px 12px",background:copiedContent?"#10B981":"#E2E8F0",color:copiedContent?"#fff":"#475569",fontSize:11,width:"100%"}}>{copiedContent?"âœ“ ë³µì‚¬ë¨":"ğŸ“‹ ë‚´ìš© ë³µì‚¬"}</button>
      </div>
    </div></div>
  );
}

// â”€â”€â”€ Settings Modal â”€â”€â”€
function SettingsModal({onClose,events,todos,memos,contacts,onRestore,doorayStatus,onDooraySync,user,cloudSt,onLogin,onLogout,fbReady}){
  const fileRef=useRef(null);
  const exportData=()=>{
    const d=JSON.stringify({events:events.filter(e=>e.source!=="dooray"),todos,memos,contacts,exportDate:new Date().toISOString()},null,2);
    const blob=new Blob([d],{type:"application/json"});const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download=`BizPlanner_${fmt(new Date())}.json`;a.click();URL.revokeObjectURL(url);
  };
  const importData=async(e)=>{
    const file=e.target.files[0];if(!file)return;
    try{const text=await file.text();const d=JSON.parse(text);
      if(d.events&&d.todos){onRestore(d);alert("ë³µì› ì™„ë£Œ!");}
      else alert("ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
    }catch{alert("íŒŒì¼ ì˜¤ë¥˜");}
  };
  return(
    <div style={modalOverlay} onClick={onClose}><div style={{...modalCont,maxWidth:380}} onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h3 style={{margin:0,fontSize:17,fontWeight:700,color:"#1E293B"}}>âš™ï¸ ì„¤ì •</h3><button onClick={onClose} style={closeS}>âœ•</button></div>
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        {/* Cloud Account */}
        <div style={{background:user?"#EFF6FF":"#F8FAFC",borderRadius:10,padding:12}}>
          <div style={{fontSize:13,fontWeight:700,color:"#1E293B",marginBottom:6}}>â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™”</div>
          {user?<>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}>
              <img src={user.photoURL||""} style={{width:32,height:32,borderRadius:"50%"}} alt="" onError={e=>{e.target.style.display="none";}}/>
              <div><div style={{fontSize:12,fontWeight:600,color:"#1E293B"}}>{user.displayName||"ì‚¬ìš©ì"}</div>
                <div style={{fontSize:10,color:"#64748B"}}>{user.email}</div></div>
            </div>
            <div style={{fontSize:11,color:cloudSt==="synced"?"#059669":cloudSt==="syncing"?"#D97706":"#94A3B8",marginBottom:6}}>
              {cloudSt==="synced"?"âœ… í´ë¼ìš°ë“œ ë™ê¸°í™”ë¨":cloudSt==="syncing"?"â³ ë™ê¸°í™” ì¤‘...":"ëŒ€ê¸° ì¤‘"}</div>
            <button onClick={onLogout} style={{...btnS,background:"#FEE2E2",color:"#DC2626",width:"100%",padding:"8px 0",fontSize:12}}>ë¡œê·¸ì•„ì›ƒ</button>
          </>:fbReady?<>
            <div style={{fontSize:12,color:"#64748B",marginBottom:8}}>ë¡œê·¸ì¸í•˜ë©´ íœ´ëŒ€í°ê³¼ PCì—ì„œ ê°™ì€ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            <button onClick={onLogin} style={{...btnS,background:"#1E293B",color:"#fff",width:"100%",padding:"10px 0",fontSize:13}}>Googleë¡œ ë¡œê·¸ì¸</button>
          </>:<div style={{fontSize:12,color:"#94A3B8"}}>Firebase ë¯¸ì„¤ì • (ë¡œì»¬ ì „ìš© ëª¨ë“œ)</div>}
        </div>
        {/* Dooray Status */}
        <div style={{background:doorayStatus?.connected?"#F0FDF4":"#FEF2F2",borderRadius:10,padding:12}}>
          <div style={{fontSize:13,fontWeight:700,color:"#1E293B",marginBottom:6}}>ğŸ”— ë‘ë ˆì´ ìº˜ë¦°ë”</div>
          {doorayStatus?.connected?
            <div style={{fontSize:12,color:"#059669"}}>âœ… ì—°ê²°ë¨ Â· {doorayStatus.calendarName||"ìº˜ë¦°ë”"} Â· {doorayStatus.totalCalendars||1}ê°œ</div>
            :<div style={{fontSize:12,color:"#DC2626"}}>âŒ ì—°ê²° ì•ˆë¨</div>}
          <button onClick={onDooraySync} style={{...btnS,background:"#3E6FE0",color:"#fff",width:"100%",padding:"8px 0",marginTop:8,fontSize:12}}>ğŸ”„ ì§€ê¸ˆ ë™ê¸°í™”</button>
        </div>
        {/* Data Stats */}
        <div style={{background:"#F8FAFC",borderRadius:10,padding:12}}>
          <div style={{fontSize:13,fontWeight:700,color:"#1E293B",marginBottom:6}}>ğŸ“Š ë°ì´í„°</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6}}>
            {[{l:"ì¼ì •",v:events.length,c:"#3B82F6"},{l:"í• ì¼",v:todos.length,c:"#10B981"},{l:"ë©”ëª¨",v:memos.length,c:"#F59E0B"},{l:"ì—°ë½ì²˜",v:contacts.length,c:"#8B5CF6"}].map(s=>
              <div key={s.l} style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:s.c}}>{s.v}</div><div style={{fontSize:9,color:"#94A3B8"}}>{s.l}</div></div>)}
          </div>
        </div>
        {/* Backup */}
        <div style={{display:"flex",gap:8}}>
          <button onClick={exportData} style={{...btnS,background:"#1E293B",color:"#fff",flex:1,padding:"10px 0",fontSize:12}}>ğŸ“¥ ë°±ì—…</button>
          <button onClick={()=>fileRef.current?.click()} style={{...btnS,background:"#3B82F6",color:"#fff",flex:1,padding:"10px 0",fontSize:12}}>ğŸ“‚ ë³µì›</button>
          <input ref={fileRef} type="file" accept=".json" onChange={importData} style={{display:"none"}}/>
        </div>
      </div>
    </div></div>
  );
}

// â”€â”€â”€ Calendar â”€â”€â”€
function Calendar({currentDate,selectedDate,onSelectDate,events,onMonthChange,onToday}){
  const yr=currentDate.getFullYear(),mo=currentDate.getMonth();
  const fd=new Date(yr,mo,1).getDay(),dim=new Date(yr,mo+1,0).getDate();
  const evDates={};
  events.forEach(e=>{
    if(!e.date) return;
    // Multi-day: mark all days in range
    if(e.endDate && e.endDate > e.date){
      let cur = pD(e.date);
      const end = pD(e.endDate);
      while(cur <= end){
        const ds = fmt(cur);
        if(!evDates[ds]) evDates[ds]=[];
        evDates[ds].push(e);
        cur = new Date(cur.getTime()+864e5);
      }
    } else {
      if(!evDates[e.date]) evDates[e.date]=[];
      evDates[e.date].push(e);
    }
  });
  const cells=[];for(let i=0;i<fd;i++)cells.push(null);for(let d=1;d<=dim;d++)cells.push(d);
  return(
    <div style={{background:"#fff",borderRadius:14,padding:"14px 10px",boxShadow:"0 1px 4px rgba(0,0,0,0.05)"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
        <button onClick={()=>onMonthChange(-1)} style={navS}>â—‚</button>
        <div style={{display:"flex",alignItems:"center",gap:6}}>
          <span style={{fontWeight:800,fontSize:16,color:"#1E293B"}}>{yr}ë…„ {MONTHS_KR[mo]}</span>
          <button onClick={onToday} style={{fontSize:9,padding:"2px 7px",borderRadius:6,border:"1px solid #E2E8F0",background:"#F8FAFC",color:"#3B82F6",fontWeight:700,cursor:"pointer"}}>ì˜¤ëŠ˜</button>
        </div>
        <button onClick={()=>onMonthChange(1)} style={navS}>â–¸</button>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:1,textAlign:"center"}}>
        {DAYS_KR.map((d,i)=><div key={d} style={{fontSize:10,fontWeight:700,color:i===0?"#EF4444":i===6?"#3B82F6":"#94A3B8",padding:"2px 0"}}>{d}</div>)}
        {cells.map((day,i)=>{
          if(!day)return<div key={`e-${i}`}/>;
          const ds=fmt(new Date(yr,mo,day)),isT=ds===TODAY,isS=ds===selectedDate,de=evDates[ds]||[],ci=i%7;
          const hasDooray=de.some(e=>e.source==="dooray");
          return(<button key={i} onClick={()=>onSelectDate(ds)}
            style={{position:"relative",border:"none",borderRadius:8,padding:"4px 2px 8px",cursor:"pointer",background:isS?"#1E293B":isT?"#EFF6FF":"transparent",
              color:isS?"#fff":ci===0?"#EF4444":ci===6?"#3B82F6":"#334155",fontWeight:isT||isS?700:400,fontSize:13,transition:"all 0.12s"}}>
            {day}
            {de.length>0&&<div style={{display:"flex",justifyContent:"center",gap:2,position:"absolute",bottom:1,left:0,right:0}}>
              {de.slice(0,3).map((ev,j)=><div key={j} style={{width:4,height:4,borderRadius:"50%",background:isS?"#fff":ev.source==="dooray"?"#3E6FE0":PRI[ev.priority]?.dot||"#94A3B8"}}/>)}</div>}
          </button>);
        })}
      </div>
    </div>
  );
}

// â”€â”€â”€ Event Card (mobile optimized) â”€â”€â”€
function EventCard({ev,onEdit,onShare,isPast,isChecked,onToggleCheck}){
  const p=PRI[ev.priority]||PRI.medium;
  const isDooray=ev.source==="dooray";
  const isMultiDay=ev.endDate&&ev.endDate!==ev.date;
  const isOngoing=ev.date<=TODAY&&(ev.endDate||ev.date)>=TODAY&&!isPast;
  const grayOut=isPast&&!isChecked;
  return(
    <div style={{background:isChecked?"#F1F5F9":grayOut?"#F8FAFC":"#fff",borderRadius:12,padding:"10px 12px",borderLeft:`4px solid ${isChecked?"#CBD5E1":grayOut?"#CBD5E1":isDooray?"#3E6FE0":p.dot}`,boxShadow:"0 1px 3px rgba(0,0,0,0.04)",cursor:"pointer",opacity:isChecked?0.5:grayOut?0.65:1,transition:"all 0.2s"}}>
      <div style={{display:"flex",alignItems:"flex-start",gap:6}}>
        {/* Checkbox */}
        <button onClick={e=>{e.stopPropagation();onToggleCheck&&onToggleCheck(ev.id);}} style={{width:20,height:20,borderRadius:5,border:`2px solid ${isChecked?"#10B981":"#CBD5E1"}`,background:isChecked?"#10B981":"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:11,flexShrink:0,marginTop:2}}>
          {isChecked&&"âœ“"}
        </button>
        <span style={{fontSize:14,flexShrink:0,marginTop:1}}>{CAT[ev.category]?.i||"ğŸ“…"}</span>
        <div style={{flex:1,minWidth:0}} onClick={()=>onEdit(ev)}>
          <div style={{display:"flex",alignItems:"center",gap:4,flexWrap:"wrap"}}>
            <span style={{fontWeight:600,fontSize:13,color:grayOut||isChecked?"#94A3B8":"#1E293B",wordBreak:"keep-all",lineHeight:1.4,textDecoration:isChecked?"line-through":"none"}}>{ev.title}</span>
            {isPast&&!isChecked&&<span style={{fontSize:9,background:"#F1F5F9",color:"#94A3B8",borderRadius:4,padding:"1px 4px",fontWeight:700,flexShrink:0}}>ì™„ë£Œ</span>}
            {isOngoing&&<span style={{fontSize:9,background:"#DCFCE7",color:"#16A34A",borderRadius:4,padding:"1px 4px",fontWeight:700,flexShrink:0}}>ì§„í–‰ì¤‘</span>}
            {isDooray&&<span style={{fontSize:9,background:"#DBEAFE",color:"#3E6FE0",borderRadius:4,padding:"1px 4px",fontWeight:700,flexShrink:0}}>ë‘ë ˆì´</span>}
          </div>
          <div style={{display:"flex",alignItems:"center",gap:4,marginTop:3,flexWrap:"wrap"}}>
            {ev.time&&<span style={{fontSize:11,color:"#94A3B8",fontWeight:500}}>{ev.time}{ev.endTime?`-${ev.endTime}`:""}</span>}
            {isMultiDay&&<span style={{fontSize:10,color:grayOut?"#94A3B8":"#3B82F6",fontWeight:500}}>ğŸ“… {ev.date} ~ {ev.endDate}</span>}
            {ev.calendarName&&<span style={{fontSize:9,color:"#94A3B8"}}>Â· {ev.calendarName}</span>}
          </div>
          {ev.attendees&&<div style={{fontSize:11,color:grayOut?"#B0B8C4":"#2563EB",marginTop:2,fontWeight:500}}>ğŸ‘¥ {ev.attendees}</div>}
          {ev.company&&<div style={{fontSize:11,color:grayOut?"#B0B8C4":"#64748B",marginTop:1}}>ğŸ¢ {ev.company}</div>}
          {ev.location&&<div style={{fontSize:11,color:grayOut?"#B0B8C4":"#64748B",marginTop:1}}>ğŸ“ {ev.location}</div>}
        </div>
        <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:2,flexShrink:0}}>
          {ev.alarm>=0&&<span style={{fontSize:8,background:"#DBEAFE",color:"#2563EB",borderRadius:3,padding:"0px 3px",fontWeight:600}}>â°</span>}
          {isDooray&&<button onClick={e=>{e.stopPropagation();if(ev.doorayId)window.open(`https://basgenbio.dooray.com/calendar/schedules/${ev.doorayId}`,"_blank");}} style={{border:"none",background:"none",cursor:"pointer",fontSize:11,padding:0,color:"#94A3B8"}}>â†—</button>}
          <button onClick={e=>{e.stopPropagation();onShare(ev);}} style={{border:"none",background:"none",cursor:"pointer",fontSize:11,padding:0,color:"#94A3B8"}}>ğŸ“¤</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Event Form â”€â”€â”€
function EventForm({event,onSave,onClose,onDelete,contacts,onAddContact,selectedDate}){
  const[f,setF]=useState(event||{id:uid(),title:"",date:selectedDate||TODAY,endDate:"",time:"09:00",endTime:"10:00",category:"meeting",priority:"medium",location:"",attendees:"",memo:"",alarm:15,company:"",source:"local"});
  const[confirmDel,setConfirmDel]=useState(false);
  const u=(k,v)=>setF(p=>({...p,[k]:v}));
  const isDooray=f.source==="dooray";
  return(
    <div style={modalOverlay} onClick={onClose}><div style={{...modalCont,maxHeight:"90vh",overflow:"auto"}} onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h3 style={{margin:0,fontSize:17,fontWeight:700,color:"#1E293B"}}>{event?"ì¼ì • ìˆ˜ì •":"ìƒˆ ì¼ì •"}{isDooray&&<span style={{fontSize:11,color:"#3E6FE0",fontWeight:500}}> (ë‘ë ˆì´)</span>}</h3><button onClick={onClose} style={closeS}>âœ•</button></div>
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        <input value={f.title} onChange={e=>u("title",e.target.value)} placeholder="ğŸ“Œ ì¼ì • ì œëª© *" style={inpS} autoFocus/>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
          <div><label style={labS}>ì‹œì‘ì¼</label><input type="date" value={f.date} onChange={e=>u("date",e.target.value)} style={inpS}/></div>
          <div><label style={labS}>ì¢…ë£Œì¼</label><input type="date" value={f.endDate||""} onChange={e=>u("endDate",e.target.value)} style={inpS}/></div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
          <div><label style={labS}>ì‹œì‘</label><input type="time" value={f.time} onChange={e=>u("time",e.target.value)} style={inpS}/></div>
          <div><label style={labS}>ì¢…ë£Œ</label><input type="time" value={f.endTime} onChange={e=>u("endTime",e.target.value)} style={inpS}/></div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
          <div><label style={labS}>ì¹´í…Œê³ ë¦¬</label><select value={f.category} onChange={e=>u("category",e.target.value)} style={inpS}>
            {Object.entries(CAT).map(([k,v])=><option key={k} value={k}>{v.i} {v.l}</option>)}</select></div>
          <div><label style={labS}>â° ì•ŒëŒ</label><select value={f.alarm} onChange={e=>u("alarm",Number(e.target.value))} style={inpS}><option value={-1}>ì—†ìŒ</option>
            {ALARM_OPTS.map(o=><option key={o.v} value={o.v}>{o.l}</option>)}</select></div>
        </div>
        <div><label style={labS}>ìš°ì„ ìˆœìœ„</label>
          <div style={{display:"flex",gap:5}}>{[["high","ìƒ"],["medium","ì¤‘"],["low","í•˜"]].map(([k,l])=>
            <button key={k} onClick={()=>u("priority",k)} style={{flex:1,padding:"7px 0",borderRadius:8,border:f.priority===k?`2px solid ${PRI[k].dot}`:"2px solid #E2E8F0",background:f.priority===k?PRI[k].bg:"#fff",color:f.priority===k?PRI[k].text:"#64748B",fontWeight:600,fontSize:12,cursor:"pointer"}}>{l}</button>
          )}</div></div>
        <CompanyAC contacts={contacts} value={f.company||""} onChange={v=>u("company",v)}/>
        <ContactPicker contacts={contacts} value={f.attendees} onChange={v=>u("attendees",v)} onAddNew={onAddContact}/>
        <input value={f.location} onChange={e=>u("location",e.target.value)} placeholder="ğŸ“ ì¥ì†Œ" style={inpS}/>
        <textarea value={f.memo} onChange={e=>u("memo",e.target.value)} placeholder="ğŸ“ ë©”ëª¨" rows={3} style={{...inpS,resize:"vertical"}}/>
      </div>
      <div style={{display:"flex",gap:6,marginTop:14}}>
        {event&&<button onClick={()=>setConfirmDel(true)} style={{...btnS,background:"#FEE2E2",color:"#DC2626",fontSize:12}}>ì‚­ì œ</button>}
        <div style={{flex:1}}/>
        <button onClick={onClose} style={{...btnS,background:"#F1F5F9",color:"#64748B",fontSize:12}}>ì·¨ì†Œ</button>
        <button onClick={()=>{if(f.title.trim())onSave(f);}} style={{...btnS,background:"#1E293B",color:"#fff",fontSize:12,opacity:f.title.trim()?1:0.4}}>
          {isDooray?"ë‘ë ˆì´ ì €ì¥":"ì €ì¥"}</button>
      </div>
      {confirmDel&&<ConfirmDialog message={`"${event.title}" ì‚­ì œ?`} onConfirm={()=>onDelete(event.id)} onCancel={()=>setConfirmDel(false)}/>}
    </div></div>
  );
}

// â”€â”€â”€ Contact Form â”€â”€â”€
function ContactForm({contact,onSave,onClose,onDelete}){
  const[f,setF]=useState(contact||{id:uid(),name:"",company:"",phone:"",email:"",position:"",notes:""});
  const[confirmDel,setConfirmDel]=useState(false);const u=(k,v)=>setF(p=>({...p,[k]:v}));
  return(
    <div style={modalOverlay} onClick={onClose}><div style={modalCont} onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h3 style={{margin:0,fontSize:17,fontWeight:700,color:"#1E293B"}}>{contact?"ì—°ë½ì²˜ ìˆ˜ì •":"ìƒˆ ì—°ë½ì²˜"}</h3><button onClick={onClose} style={closeS}>âœ•</button></div>
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        <input value={f.name} onChange={e=>u("name",e.target.value)} placeholder="ğŸ‘¤ ì´ë¦„ *" style={inpS} autoFocus/>
        <input value={f.company} onChange={e=>u("company",e.target.value)} placeholder="ğŸ¢ íšŒì‚¬" style={inpS}/>
        <input value={f.position} onChange={e=>u("position",e.target.value)} placeholder="ğŸ’¼ ì§ì±…" style={inpS}/>
        <input value={f.phone} onChange={e=>u("phone",e.target.value)} placeholder="ğŸ“± ì „í™”ë²ˆí˜¸" style={inpS} type="tel"/>
        <input value={f.email} onChange={e=>u("email",e.target.value)} placeholder="ğŸ“§ ì´ë©”ì¼" style={inpS} type="email"/>
        <textarea value={f.notes} onChange={e=>u("notes",e.target.value)} placeholder="ğŸ“ ë©”ëª¨" rows={2} style={{...inpS,resize:"vertical"}}/>
      </div>
      <div style={{display:"flex",gap:6,marginTop:14}}>
        {contact&&<button onClick={()=>setConfirmDel(true)} style={{...btnS,background:"#FEE2E2",color:"#DC2626",fontSize:12}}>ì‚­ì œ</button>}
        <div style={{flex:1}}/><button onClick={onClose} style={{...btnS,background:"#F1F5F9",color:"#64748B",fontSize:12}}>ì·¨ì†Œ</button>
        <button onClick={()=>{if(f.name.trim())onSave(f);}} style={{...btnS,background:"#1E293B",color:"#fff",fontSize:12,opacity:f.name.trim()?1:0.4}}>ì €ì¥</button></div>
      {confirmDel&&<ConfirmDialog message={`"${contact.name}" ì‚­ì œ?`} onConfirm={()=>onDelete(contact.id)} onCancel={()=>setConfirmDel(false)}/>}
    </div></div>
  );
}

// â”€â”€â”€ Todo Form â”€â”€â”€
function TodoForm({todo,onSave,onClose,onDelete}){
  const[f,setF]=useState(todo||{id:uid(),title:"",priority:"medium",createdDate:TODAY,completed:false,completedDate:null,category:"ì—…ë¬´",notes:"",dueDate:""});
  const[confirmDel,setConfirmDel]=useState(false);const u=(k,v)=>setF(p=>({...p,[k]:v}));
  return(
    <div style={modalOverlay} onClick={onClose}><div style={modalCont} onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h3 style={{margin:0,fontSize:17,fontWeight:700,color:"#1E293B"}}>{todo?"í•  ì¼ ìˆ˜ì •":"ìƒˆ í•  ì¼"}</h3><button onClick={onClose} style={closeS}>âœ•</button></div>
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        <input value={f.title} onChange={e=>u("title",e.target.value)} placeholder="âœï¸ í•  ì¼ *" style={inpS} autoFocus/>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
          <div><label style={labS}>ì¹´í…Œê³ ë¦¬</label><select value={f.category} onChange={e=>u("category",e.target.value)} style={inpS}>
            {TODO_CATS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
          <div><label style={labS}>ğŸ“… ë§ˆê°ì¼</label><input type="date" value={f.dueDate||""} onChange={e=>u("dueDate",e.target.value)} style={inpS}/></div>
        </div>
        <div><label style={labS}>ìš°ì„ ìˆœìœ„</label>
          <div style={{display:"flex",gap:5}}>{[["high","ìƒ"],["medium","ì¤‘"],["low","í•˜"]].map(([k,l])=>
            <button key={k} onClick={()=>u("priority",k)} style={{flex:1,padding:"7px 0",borderRadius:8,border:f.priority===k?`2px solid ${PRI[k].dot}`:"2px solid #E2E8F0",background:f.priority===k?PRI[k].bg:"#fff",color:f.priority===k?PRI[k].text:"#64748B",fontWeight:600,fontSize:12,cursor:"pointer"}}>{l}</button>
          )}</div></div>
        <textarea value={f.notes} onChange={e=>u("notes",e.target.value)} placeholder="ğŸ“ ë©”ëª¨" rows={2} style={{...inpS,resize:"vertical"}}/>
      </div>
      <div style={{display:"flex",gap:6,marginTop:14}}>
        {todo&&<button onClick={()=>setConfirmDel(true)} style={{...btnS,background:"#FEE2E2",color:"#DC2626",fontSize:12}}>ì‚­ì œ</button>}
        <div style={{flex:1}}/><button onClick={onClose} style={{...btnS,background:"#F1F5F9",color:"#64748B",fontSize:12}}>ì·¨ì†Œ</button>
        <button onClick={()=>{if(f.title.trim())onSave(f);}} style={{...btnS,background:"#1E293B",color:"#fff",fontSize:12,opacity:f.title.trim()?1:0.4}}>ì €ì¥</button></div>
      {confirmDel&&<ConfirmDialog message={`"${todo.title}" ì‚­ì œ?`} onConfirm={()=>onDelete(todo.id)} onCancel={()=>setConfirmDel(false)}/>}
    </div></div>
  );
}

// â”€â”€â”€ Memo Form â”€â”€â”€
function MemoForm({memo,onSave,onClose,onDelete}){
  const[f,setF]=useState(memo||{id:uid(),title:"",date:TODAY,type:"free",content:"",attendees:"",agenda:"",decisions:"",actionItems:"",nextMeeting:"",tags:"",attachments:[],voiceNotes:[]});
  const[confirmDel,setConfirmDel]=useState(false);const u=(k,v)=>setF(p=>({...p,[k]:v}));
  const mt=MEMO_T[f.type]||MEMO_T.free;const fileRef=useRef(null);const camRef=useRef(null);const[recording,setRecording]=useState(false);
  const handleFile=e=>{const files=Array.from(e.target.files||[]);const atts=files.map(f=>{const r={id:uid(),name:f.name,type:f.type.startsWith("image/")?"image":"file",size:f.size};if(r.type==="image")r.preview=URL.createObjectURL(f);return r;});u("attachments",[...(f.attachments||[]),...atts]);};
  const handleCamera=e=>{const file=e.target.files?.[0];if(file)u("attachments",[...(f.attachments||[]),{id:uid(),name:`photo_${Date.now()}.jpg`,type:"image",preview:URL.createObjectURL(file)}]);};
  const startRec=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:true});const mr=new MediaRecorder(s);const ch=[];mr.ondataavailable=e=>ch.push(e.data);mr.onstop=()=>{s.getTracks().forEach(t=>t.stop());u("voiceNotes",[...(f.voiceNotes||[]),{id:uid(),date:new Date().toLocaleString("ko-KR")}]);};mr.start();setRecording(true);setTimeout(()=>{if(mr.state==="recording"){mr.stop();setRecording(false);}},60000);window._rec=mr;}catch{}};
  const stopRec=()=>{if(window._rec&&window._rec.state==="recording")window._rec.stop();setRecording(false);};
  return(
    <div style={modalOverlay} onClick={onClose}><div style={{...modalCont,maxHeight:"90vh",overflow:"auto"}} onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h3 style={{margin:0,fontSize:17,fontWeight:700,color:"#1E293B"}}>{memo?"ë©”ëª¨ ìˆ˜ì •":"ìƒˆ ë©”ëª¨"}</h3><button onClick={onClose} style={closeS}>âœ•</button></div>
      <div style={{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}}>
        {Object.entries(MEMO_T).map(([k,v])=><button key={k} onClick={()=>u("type",k)}
          style={{padding:"4px 8px",borderRadius:16,border:f.type===k?`2px solid ${v.color}`:"2px solid #E2E8F0",background:f.type===k?v.color+"18":"#fff",color:f.type===k?v.color:"#64748B",fontWeight:600,fontSize:10,cursor:"pointer"}}>
          {v.icon} {v.label}</button>)}
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        <input value={f.title} onChange={e=>u("title",e.target.value)} placeholder={`${mt.icon} ì œëª© *`} style={inpS} autoFocus/>
        <input type="date" value={f.date} onChange={e=>u("date",e.target.value)} style={inpS}/>
        {f.type==="meeting"&&<>
          <input value={f.attendees} onChange={e=>u("attendees",e.target.value)} placeholder="ğŸ‘¥ ì°¸ì„ì" style={inpS}/>
          <textarea value={f.agenda} onChange={e=>u("agenda",e.target.value)} placeholder="ğŸ“‹ ì•ˆê±´" rows={2} style={{...inpS,resize:"vertical"}}/>
          <textarea value={f.decisions} onChange={e=>u("decisions",e.target.value)} placeholder="âœ… ê²°ì •ì‚¬í•­" rows={2} style={{...inpS,resize:"vertical"}}/>
          <textarea value={f.actionItems} onChange={e=>u("actionItems",e.target.value)} placeholder="ğŸ¯ Action Items" rows={2} style={{...inpS,resize:"vertical"}}/>
          <input value={f.nextMeeting} onChange={e=>u("nextMeeting",e.target.value)} placeholder="ğŸ“… ë‹¤ìŒ ë¯¸íŒ…" style={inpS}/></>}
        {f.type==="idea"&&<><textarea value={f.content} onChange={e=>u("content",e.target.value)} placeholder="ğŸ’¡ ì•„ì´ë””ì–´..." rows={4} style={{...inpS,resize:"vertical"}}/>
          <input value={f.tags} onChange={e=>u("tags",e.target.value)} placeholder="ğŸ·ï¸ íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)" style={inpS}/></>}
        {f.type!=="meeting"&&f.type!=="idea"&&<textarea value={f.content} onChange={e=>u("content",e.target.value)}
          placeholder={f.type==="diary"?"ğŸ“” ì˜¤ëŠ˜ì˜ ì¼ê¸°...":"ğŸ“ ë©”ëª¨..."} rows={4} style={{...inpS,resize:"vertical"}}/>}
        <div style={{background:"#F8FAFC",borderRadius:10,padding:10}}>
          <div style={{fontSize:10,fontWeight:700,color:"#64748B",marginBottom:6}}>ğŸ“ ì²¨ë¶€</div>
          <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
            <button onClick={()=>fileRef.current?.click()} style={attachBtnS}>ğŸ“ íŒŒì¼</button>
            <input ref={fileRef} type="file" multiple accept="image/*,.pdf,.doc,.docx" onChange={handleFile} style={{display:"none"}}/>
            <button onClick={()=>camRef.current?.click()} style={attachBtnS}>ğŸ“· ì‚¬ì§„</button>
            <input ref={camRef} type="file" accept="image/*" capture="environment" onChange={handleCamera} style={{display:"none"}}/>
            <button onClick={recording?stopRec:startRec} style={{...attachBtnS,border:recording?"2px solid #EF4444":"2px dashed #CBD5E1",background:recording?"#FEE2E2":"#fff",color:recording?"#DC2626":"#64748B"}}>
              ğŸ™ï¸ {recording?"ì¤‘ì§€":"ìŒì„±"}</button>
          </div>
          {(f.attachments?.length>0||f.voiceNotes?.length>0)&&<div style={{marginTop:6,display:"flex",flexDirection:"column",gap:3}}>
            {f.attachments?.map((a,i)=><div key={a.id} style={{display:"flex",alignItems:"center",gap:4,background:"#fff",borderRadius:6,padding:"4px 6px"}}>
              {a.type==="image"&&a.preview?<img src={a.preview} style={{width:24,height:24,borderRadius:4,objectFit:"cover"}} alt=""/>:<span>ğŸ“„</span>}
              <span style={{flex:1,fontSize:10,color:"#475569",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{a.name}</span>
              <button onClick={()=>u("attachments",f.attachments.filter((_,j)=>j!==i))} style={{border:"none",background:"none",color:"#94A3B8",cursor:"pointer",fontSize:12,padding:0}}>âœ•</button></div>)}
            {f.voiceNotes?.map((v,i)=><div key={v.id} style={{display:"flex",alignItems:"center",gap:4,background:"#fff",borderRadius:6,padding:"4px 6px"}}>
              <span>ğŸ™ï¸</span><span style={{flex:1,fontSize:10,color:"#475569"}}>ìŒì„± ({v.date})</span>
              <button onClick={()=>u("voiceNotes",f.voiceNotes.filter((_,j)=>j!==i))} style={{border:"none",background:"none",color:"#94A3B8",cursor:"pointer",fontSize:12,padding:0}}>âœ•</button></div>)}
          </div>}
        </div>
      </div>
      <div style={{display:"flex",gap:6,marginTop:14}}>
        {memo&&<button onClick={()=>setConfirmDel(true)} style={{...btnS,background:"#FEE2E2",color:"#DC2626",fontSize:12}}>ì‚­ì œ</button>}
        <div style={{flex:1}}/><button onClick={onClose} style={{...btnS,background:"#F1F5F9",color:"#64748B",fontSize:12}}>ì·¨ì†Œ</button>
        <button onClick={()=>{if(f.title.trim())onSave(f);}} style={{...btnS,background:"#1E293B",color:"#fff",fontSize:12,opacity:f.title.trim()?1:0.4}}>ì €ì¥</button></div>
      {confirmDel&&<ConfirmDialog message={`"${memo.title}" ì‚­ì œ?`} onConfirm={()=>onDelete(memo.id)} onCancel={()=>setConfirmDel(false)}/>}
    </div></div>
  );
}

// â”€â”€â”€ Routine Tab â”€â”€â”€
function RoutineTab({routines,onToggle,today}){
  const[view,setView]=useState("today"); // today, week, month, year
  const todayData=routines[today]||{};
  const done=ROUTINES.filter(r=>todayData[r.id]).length;
  const total=ROUTINES.length;
  const pct=total>0?Math.round(done/total*100):0;

  // Stats calculator
  const calcStats=(days)=>{
    const result={};
    ROUTINES.forEach(r=>{
      let cnt=0;
      days.forEach(d=>{if(routines[d]&&routines[d][r.id])cnt++;});
      result[r.id]={done:cnt,total:days.length,pct:days.length>0?Math.round(cnt/days.length*100):0};
    });
    let totalDone=0,totalPossible=days.length*ROUTINES.length;
    days.forEach(d=>{ROUTINES.forEach(r=>{if(routines[d]&&routines[d][r.id])totalDone++;});});
    result._overall={done:totalDone,total:totalPossible,pct:totalPossible>0?Math.round(totalDone/totalPossible*100):0};
    result._days=days;
    return result;
  };

  const getDays=(type)=>{
    const d=[];const now=new Date();
    if(type==="week"){for(let i=6;i>=0;i--){const t=new Date(now);t.setDate(t.getDate()-i);d.push(fmt(t));}}
    else if(type==="month"){const y=now.getFullYear(),m=now.getMonth();for(let i=1;i<=now.getDate();i++)d.push(fmt(new Date(y,m,i)));}
    else if(type==="year"){const y=now.getFullYear();let cur=new Date(y,0,1);while(cur<=now){d.push(fmt(cur));cur=new Date(cur.getTime()+864e5);}}
    return d;
  };

  // Streak
  let streak=0;
  {let d=new Date();
    while(true){const ds=fmt(d);const rd=routines[ds];
      if(rd&&ROUTINES.every(r=>rd[r.id])){streak++;d=new Date(d.getTime()-864e5);}
      else break;
    }
  }

  const stats=view!=="today"?calcStats(getDays(view)):null;

  return(<div>
    {/* Today Progress */}
    <div style={{background:"linear-gradient(135deg,#0F172A,#1E3A5F)",borderRadius:16,padding:"16px 14px",marginBottom:12}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
        <div><div style={{fontSize:10,fontWeight:700,color:"#94A3B8",letterSpacing:1.5}}>ğŸ”¥ ì˜¤ëŠ˜ì˜ ë£¨í‹´</div>
          <div style={{fontSize:13,fontWeight:700,color:"#E2E8F0",marginTop:2}}>{(()=>{const d=new Date();return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${DAYS_KR[d.getDay()]})`})()}</div>
          <div style={{fontSize:22,fontWeight:900,color:"#fff",marginTop:2}}>{done}/{total} <span style={{fontSize:13,color:pct===100?"#4ADE80":"#FBBF24"}}>{pct}%</span></div></div>
        <div style={{textAlign:"center"}}>
          <div style={{fontSize:28,fontWeight:900,color:streak>0?"#F97316":"#475569"}}>{streak}</div>
          <div style={{fontSize:9,color:"#94A3B8",fontWeight:600}}>ì—°ì†ì¼</div></div>
      </div>
      {/* Progress bar */}
      <div style={{background:"rgba(255,255,255,0.1)",borderRadius:10,height:8,overflow:"hidden"}}>
        <div style={{width:`${pct}%`,height:"100%",background:pct===100?"linear-gradient(90deg,#4ADE80,#22C55E)":"linear-gradient(90deg,#3B82F6,#8B5CF6)",borderRadius:10,transition:"width 0.5s"}}/>
      </div>
      {pct===100&&<div style={{textAlign:"center",marginTop:8,fontSize:12,color:"#4ADE80",fontWeight:700}}>ğŸ‰ ì˜¤ëŠ˜ ë£¨í‹´ ì™„ë£Œ!</div>}
    </div>

    {/* Today's checklist */}
    <div style={{display:"flex",flexDirection:"column",gap:6,marginBottom:14}}>
      {ROUTINES.map(r=>{const checked=!!todayData[r.id];return(
        <div key={r.id} onClick={()=>onToggle(today,r.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"12px 14px",background:checked?"#F0FDF4":"#fff",borderRadius:12,cursor:"pointer",borderLeft:`4px solid ${checked?"#22C55E":"#E2E8F0"}`,boxShadow:"0 1px 3px rgba(0,0,0,0.04)",transition:"all 0.2s"}}>
          <div style={{width:24,height:24,borderRadius:7,border:`2px solid ${checked?"#22C55E":"#CBD5E1"}`,background:checked?"#22C55E":"#fff",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:14,fontWeight:700,flexShrink:0,transition:"all 0.2s"}}>
            {checked&&"âœ“"}</div>
          <span style={{fontSize:18,flexShrink:0}}>{r.icon}</span>
          <span style={{fontSize:14,fontWeight:600,color:checked?"#16A34A":"#1E293B",textDecoration:checked?"line-through":"none",flex:1}}>{r.label}</span>
          {checked&&<span style={{fontSize:10,color:"#22C55E",fontWeight:700}}>ì™„ë£Œ</span>}
        </div>);})}
    </div>

    {/* Stats Toggle */}
    <div style={{display:"flex",gap:4,marginBottom:10}}>
      {[["today","ì˜¤ëŠ˜"],["week","ì£¼ê°„"],["month","ì›”ê°„"],["year","ì—°ê°„"]].map(([k,l])=>
        <button key={k} onClick={()=>setView(k)} style={{flex:1,padding:"7px 0",borderRadius:8,border:view===k?"2px solid #1E293B":"2px solid #E2E8F0",background:view===k?"#1E293B":"#fff",color:view===k?"#fff":"#64748B",fontWeight:700,fontSize:11,cursor:"pointer"}}>{l}</button>)}
    </div>

    {/* Stats View */}
    {stats&&<div style={{background:"#fff",borderRadius:14,padding:14,boxShadow:"0 1px 4px rgba(0,0,0,0.05)"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
        <div style={{fontSize:14,fontWeight:700,color:"#1E293B"}}>ğŸ“Š {view==="week"?"ì£¼ê°„":view==="month"?"ì›”ê°„":"ì—°ê°„"} í†µê³„</div>
        <div style={{fontSize:22,fontWeight:900,color:stats._overall.pct>=80?"#22C55E":stats._overall.pct>=50?"#F59E0B":"#EF4444"}}>{stats._overall.pct}%</div>
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:8}}>
        {ROUTINES.map(r=>{const s=stats[r.id];return(
          <div key={r.id}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
              <span style={{fontSize:12,fontWeight:600,color:"#1E293B"}}>{r.icon} {r.short}</span>
              <span style={{fontSize:11,color:"#64748B"}}>{s.done}/{s.total}ì¼ ({s.pct}%)</span>
            </div>
            <div style={{background:"#F1F5F9",borderRadius:6,height:6,overflow:"hidden"}}>
              <div style={{width:`${s.pct}%`,height:"100%",background:s.pct>=80?"#22C55E":s.pct>=50?"#F59E0B":"#EF4444",borderRadius:6,transition:"width 0.4s"}}/>
            </div>
          </div>);})}
      </div>
      {/* Heatmap for week view */}
      {view==="week"&&<div style={{marginTop:12}}>
        <div style={{fontSize:11,fontWeight:700,color:"#64748B",marginBottom:6}}>ì¼ë³„ ë‹¬ì„±</div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3}}>
          {stats._days.map(d=>{const rd=routines[d]||{};const cnt=ROUTINES.filter(r=>rd[r.id]).length;const dp=pD(d);
            return(<div key={d} style={{textAlign:"center",padding:"4px 0",borderRadius:6,background:cnt===ROUTINES.length?"#DCFCE7":cnt>0?"#FEF3C7":"#F1F5F9"}}>
              <div style={{fontSize:8,color:"#94A3B8"}}>{DAYS_KR[dp.getDay()]}</div>
              <div style={{fontSize:12,fontWeight:800,color:cnt===ROUTINES.length?"#22C55E":cnt>0?"#F59E0B":"#CBD5E1"}}>{cnt}</div>
              <div style={{fontSize:7,color:"#94A3B8"}}>{dp.getDate()}ì¼</div>
            </div>);})}
        </div>
      </div>}
    </div>}
  </div>);
}

// â”€â”€â”€ News Tab â”€â”€â”€
function NewsTab(){
  const[news,setNews]=useState(null);const[newsLoading,setNewsLoading]=useState(false);const[newsFilter,setNewsFilter]=useState("all");const[newsRegion,setNewsRegion]=useState("all");
  const fetchNews=async()=>{
    setNewsLoading(true);
    try{
      const r=await fetch(NEWS_API);const d=await r.json();
      if(d.articles)setNews(d.articles);
    }catch(e){console.error("News fetch:",e);}
    setNewsLoading(false);
  };
  useEffect(()=>{fetchNews();},[]);
  const filtered=news?news.filter(a=>(newsFilter==="all"||a.category===newsFilter)&&(newsRegion==="all"||a.region===newsRegion)):[];
  return(<div>
    <div style={{display:"flex",gap:4,marginBottom:8,flexWrap:"wrap"}}>
      {[["all","ì „ì²´"],["bio","ë°”ì´ì˜¤"],["pharma","ì œì•½"],["medical","ì˜ë£Œ"],["ai","AI"]].map(([k,l])=>
        <button key={k} onClick={()=>setNewsFilter(k)} style={{padding:"4px 10px",borderRadius:16,border:newsFilter===k?"2px solid #1E293B":"2px solid #E2E8F0",background:newsFilter===k?"#1E293B":"#fff",color:newsFilter===k?"#fff":"#64748B",fontWeight:600,fontSize:10,cursor:"pointer"}}>{l}</button>)}
    </div>
    <div style={{display:"flex",gap:4,marginBottom:10}}>
      {[["all","ì „ì²´"],["kr","ğŸ‡°ğŸ‡· êµ­ë‚´"],["intl","ğŸŒ í•´ì™¸"]].map(([k,l])=>
        <button key={k} onClick={()=>setNewsRegion(k)} style={{padding:"4px 10px",borderRadius:16,border:newsRegion===k?"2px solid #3B82F6":"2px solid #E2E8F0",background:newsRegion===k?"#EFF6FF":"#fff",color:newsRegion===k?"#2563EB":"#64748B",fontWeight:600,fontSize:10,cursor:"pointer"}}>{l}</button>)}
      <div style={{flex:1}}/>
      <button onClick={fetchNews} style={{padding:"4px 10px",borderRadius:16,border:"2px solid #E2E8F0",background:"#fff",color:"#64748B",fontWeight:600,fontSize:10,cursor:"pointer"}}>ğŸ”„</button>
    </div>
    {newsLoading?<div style={{textAlign:"center",padding:"40px 0",color:"#94A3B8"}}><div style={{fontSize:28}}>ğŸ“°</div><div style={{fontSize:13,marginTop:4}}>ê¸°ì‚¬ ë¡œë”© ì¤‘...</div></div>
    :!news?<div style={{textAlign:"center",padding:"40px 0",color:"#94A3B8"}}><div style={{fontSize:28}}>ğŸ“°</div><div style={{fontSize:13,marginTop:4}}>ê¸°ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div><div style={{fontSize:11,marginTop:4,color:"#CBD5E1"}}>api/news.js ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤</div></div>
    :filtered.length===0?<div style={{textAlign:"center",padding:"30px 0",color:"#94A3B8"}}>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
    :<div style={{display:"flex",flexDirection:"column",gap:8}}>
      {filtered.map((a,i)=>(
        <a key={i} href={a.link} target="_blank" rel="noopener noreferrer" style={{textDecoration:"none",background:"#fff",borderRadius:12,padding:"12px 14px",boxShadow:"0 1px 4px rgba(0,0,0,0.05)",display:"block",transition:"transform 0.15s",cursor:"pointer"}}
          onMouseEnter={e=>e.currentTarget.style.transform="translateY(-1px)"} onMouseLeave={e=>e.currentTarget.style.transform="none"}>
          <div style={{display:"flex",gap:6,marginBottom:6,flexWrap:"wrap"}}>
            <span style={{fontSize:9,padding:"1px 6px",borderRadius:4,fontWeight:700,
              background:a.category==="bio"?"#DCFCE7":a.category==="pharma"?"#DBEAFE":a.category==="medical"?"#FEF3C7":"#F3E8FF",
              color:a.category==="bio"?"#16A34A":a.category==="pharma"?"#2563EB":a.category==="medical"?"#D97706":"#7C3AED"
            }}>{a.category==="bio"?"ë°”ì´ì˜¤":a.category==="pharma"?"ì œì•½":a.category==="medical"?"ì˜ë£Œ":"AI"}</span>
            <span style={{fontSize:9,padding:"1px 6px",borderRadius:4,fontWeight:600,background:a.region==="kr"?"#FFF1F2":"#F0F9FF",color:a.region==="kr"?"#E11D48":"#0369A1"}}>{a.region==="kr"?"ğŸ‡°ğŸ‡· êµ­ë‚´":"ğŸŒ í•´ì™¸"}</span>
            {a.source&&<span style={{fontSize:9,color:"#94A3B8"}}>{a.source}</span>}
          </div>
          <div style={{fontSize:14,fontWeight:700,color:"#1E293B",lineHeight:1.5,marginBottom:4,wordBreak:"keep-all"}}>{a.title}</div>
          {a.description&&<div style={{fontSize:12,color:"#64748B",lineHeight:1.5,display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"}}>{a.description}</div>}
          <div style={{fontSize:10,color:"#94A3B8",marginTop:6}}>{a.pubDate||""}</div>
        </a>))}
    </div>}
  </div>);
}

// â”€â”€â”€ PubMed Tab â”€â”€â”€
function PubMedTab(){
  const[papers,setPapers]=useState([]);const[pmLoading,setPmLoading]=useState(false);const[pmQuery,setPmQuery]=useState("drug discovery AI");
  const queries=["drug discovery AI","multi-omics biomarker","clinical trial simulation","HDAC6 inhibitor","sarcopenia treatment","digital twin medicine"];
  const searchPubMed=async(q)=>{
    setPmLoading(true);setPmQuery(q);
    try{
      const sr=await fetch(`${PUBMED_BASE}/esearch.fcgi?db=pubmed&term=${encodeURIComponent(q)}&retmax=15&sort=date&retmode=json`);
      const sd=await sr.json();const ids=(sd.esearchresult?.idlist||[]).join(",");
      if(!ids){setPapers([]);setPmLoading(false);return;}
      const dr=await fetch(`${PUBMED_BASE}/esummary.fcgi?db=pubmed&id=${ids}&retmode=json`);
      const dd=await dr.json();
      const ps=Object.values(dd.result||{}).filter(p=>p.uid).map(p=>({
        pmid:p.uid,title:p.title,authors:(p.authors||[]).slice(0,3).map(a=>a.name).join(", "),
        journal:p.source,date:p.pubdate,doi:p.elocationid||""
      }));
      setPapers(ps);
    }catch(e){console.error("PubMed:",e);setPapers([]);}
    setPmLoading(false);
  };
  useEffect(()=>{searchPubMed("drug discovery AI");},[]);
  return(<div>
    <div style={{display:"flex",gap:4,marginBottom:10,flexWrap:"wrap"}}>
      {queries.map(q=><button key={q} onClick={()=>searchPubMed(q)} style={{padding:"4px 8px",borderRadius:16,border:pmQuery===q?"2px solid #059669":"2px solid #E2E8F0",background:pmQuery===q?"#ECFDF5":"#fff",color:pmQuery===q?"#059669":"#64748B",fontWeight:600,fontSize:9,cursor:"pointer",whiteSpace:"nowrap"}}>{q}</button>)}
    </div>
    {pmLoading?<div style={{textAlign:"center",padding:"40px 0",color:"#94A3B8"}}><div style={{fontSize:28}}>ğŸ”¬</div><div style={{fontSize:13,marginTop:4}}>ë…¼ë¬¸ ê²€ìƒ‰ ì¤‘...</div></div>
    :papers.length===0?<div style={{textAlign:"center",padding:"30px 0",color:"#94A3B8"}}>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
    :<div style={{display:"flex",flexDirection:"column",gap:6}}>
      {papers.map(p=>(
        <a key={p.pmid} href={`https://pubmed.ncbi.nlm.nih.gov/${p.pmid}/`} target="_blank" rel="noopener noreferrer"
          style={{textDecoration:"none",background:"#fff",borderRadius:12,padding:"12px 14px",borderLeft:"4px solid #059669",boxShadow:"0 1px 3px rgba(0,0,0,0.04)",display:"block"}}>
          <div style={{fontSize:13,fontWeight:700,color:"#1E293B",lineHeight:1.5,marginBottom:4,wordBreak:"keep-all"}}>{p.title}</div>
          <div style={{fontSize:11,color:"#64748B",marginBottom:2}}>{p.authors}{p.authors?"...":""}</div>
          <div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"}}>
            <span style={{fontSize:10,color:"#059669",fontWeight:600}}>{p.journal}</span>
            <span style={{fontSize:10,color:"#94A3B8"}}>{p.date}</span>
            <span style={{fontSize:9,background:"#ECFDF5",color:"#059669",padding:"1px 5px",borderRadius:4,fontWeight:600}}>PMID:{p.pmid}</span>
          </div>
        </a>))}
    </div>}
  </div>);
}

// â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•
function BizPlanner(){
  const[events,setEvents]=useState([]);const[todos,setTodos]=useState([]);const[memos,setMemos]=useState([]);const[contacts,setContacts]=useState([]);
  const[loading,setLoading]=useState(true);const[tab,setTab]=useState("routine");
  const[curDate,setCurDate]=useState(new Date());const[selDate,setSelDate]=useState(TODAY);
  const[showEF,setShowEF]=useState(false);const[showTF,setShowTF]=useState(false);const[showMF,setShowMF]=useState(false);const[showCF,setShowCF]=useState(false);
  const[editEv,setEditEv]=useState(null);const[editTd,setEditTd]=useState(null);const[editMe,setEditMe]=useState(null);const[editCo,setEditCo]=useState(null);
  const[shareItem,setShareItem]=useState(null);const[showSettings,setShowSettings]=useState(false);
  const[search,setSearch]=useState("");const[todoFilt,setTodoFilt]=useState("all");const[memoFilt,setMemoFilt]=useState("all");
  const[todoSort,setTodoSort]=useState("priority");const[syncSt,setSyncSt]=useState("idle");const[globalSearch,setGlobalSearch]=useState(false);
  const[doorayStatus,setDoorayStatus]=useState(null);const[lastSync,setLastSync]=useState(null);
  const[checkedEvs,setCheckedEvs]=useState(()=>{try{return JSON.parse(localStorage.getItem("bp-checked-evs")||"[]");}catch{return[];}});
  const[showChecked,setShowChecked]=useState(false);
  const[routines,setRoutines]=useState(()=>ld("bp-routines",{}));
  // â”€â”€â”€ Auth State â”€â”€â”€
  const[user,setUser]=useState(null);
  const[authLoading,setAuthLoading]=useState(!!fbAuth);
  const[skipLogin,setSkipLogin]=useState(()=>!!localStorage.getItem("bp-skip-login"));
  const[cloudSt,setCloudSt]=useState("idle"); // idle, syncing, synced, error
  const syncRef=useRef(null);

  // â”€â”€â”€ Auth Listener â”€â”€â”€
  useEffect(()=>{
    if(!fbAuth){setAuthLoading(false);return;}
    // Handle redirect result (for mobile login)
    fbAuth.getRedirectResult().catch(e=>console.warn("Redirect result:",e));
    // Give Firebase time to check persisted auth state before showing login
    let resolved=false;
    const unsub=fbAuth.onAuthStateChanged(u=>{
      if(!resolved){
        resolved=true;
        // Small delay to prevent login screen flash
        setTimeout(()=>{setUser(u);setAuthLoading(false);},300);
      } else {
        setUser(u);
      }
    });
    // Safety timeout - if auth never fires, stop loading
    const timeout=setTimeout(()=>{if(!resolved){resolved=true;setAuthLoading(false);}},3000);
    return()=>{unsub();clearTimeout(timeout);};
  },[]);
  const login=()=>{
    if(!fbAuth||!fbGoogle)return;
    // Mobile: use redirect (popups often blocked), Desktop: use popup
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if(isMobile){
      fbAuth.signInWithRedirect(fbGoogle).catch(e=>console.error("Login redirect error:",e));
    } else {
      fbAuth.signInWithPopup(fbGoogle).catch(e=>{
        console.error("Login popup error:",e);
        // Fallback to redirect if popup blocked
        if(e.code==='auth/popup-blocked'||e.code==='auth/popup-closed-by-user'){
          fbAuth.signInWithRedirect(fbGoogle);
        }
      });
    }
  };
  const logout=()=>{if(fbAuth)fbAuth.signOut();setSkipLogin(false);localStorage.removeItem("bp-skip-login");};

  // â”€â”€â”€ Dooray Sync â”€â”€â”€
  const syncDooray = useCallback(async (currentLocalEvents)=>{
    try {
      setSyncSt("syncing");
      const now = new Date();
      const from = fmt(new Date(now.getFullYear(), now.getMonth()-1, 1));
      const to = fmt(new Date(now.getFullYear(), now.getMonth()+3, 0));
      const data = await doorayFetch("list",{from,to});
      if(!data || !data.events) { setSyncSt("error"); return currentLocalEvents; }
      
      // Also get status
      const status = await doorayFetch("status");
      if(status) setDoorayStatus(status);
      
      // Merge: keep local events, add/update dooray events
      const localOnly = (currentLocalEvents||[]).filter(e=>e.source!=="dooray");
      const doorayEvs = data.events.map(de=>({
        ...de,
        source:"dooray",
        alarm:-1,
        priority: de.priority || "medium",
        category: de.category || "meeting",
      }));
      
      const merged = [...localOnly, ...doorayEvs];
      sv("bp-events", merged);
      setEvents(merged);
      setSyncSt("synced");
      setLastSync(new Date());
      return merged;
    } catch(e) {
      console.error("Dooray sync error:",e);
      setSyncSt("error");
      return currentLocalEvents;
    }
  },[]);

  // â”€â”€â”€ Push to Dooray â”€â”€â”€
  const pushToDooray = useCallback(async (ev, action="create")=>{
    try {
      if(action==="create"){
        const result = await doorayPost("create",{
          title: ev.title,
          date: ev.date,
          endDate: ev.endDate || ev.date,
          time: ev.time || "09:00",
          endTime: ev.endTime || "10:00",
          location: ev.location || "",
          memo: ev.memo || "",
          attendees: ev.attendees || ""
        });
        return result;
      } else if(action==="update" && ev.doorayId){
        return await doorayPost("update",{
          doorayId: ev.doorayId,
          title: ev.title,
          date: ev.date,
          endDate: ev.endDate || ev.date,
          time: ev.time || "09:00",
          endTime: ev.endTime || "10:00",
          location: ev.location || "",
          memo: ev.memo || "",
        });
      } else if(action==="delete" && ev.doorayId){
        return await doorayFetch("delete",{doorayId: ev.doorayId});
      }
    } catch(e){ console.error("Push to Dooray error:",e); }
    return null;
  },[]);

  // â”€â”€â”€ Init: load local + cloud + Dooray â”€â”€â”€
  useEffect(()=>{
    if(authLoading) return; // Wait for auth to resolve
    requestNotifPermission();
    
    if(user && fbDb){
      // Logged in â†’ load from cloud
      setCloudSt("syncing");
      cloudLoad(user.uid).then(cloud=>{
        if(cloud && cloud['bp-events']){
          const ce=cloud['bp-events']||[],ct=cloud['bp-todos']||[],cm=cloud['bp-memos']||[],cc=cloud['bp-contacts']||[],cr=cloud['bp-routines']||{};
          setEvents(ce);sv('bp-events',ce);
          setTodos(ct);sv('bp-todos',ct);
          setMemos(cm);sv('bp-memos',cm);
          setContacts(cc);sv('bp-contacts',cc);
          setRoutines(cr);sv('bp-routines',cr);
          setCloudSt("synced");
          setLoading(false);
          syncDooray(ce);
        } else {
          // First login â†’ upload local data to cloud
          const e=ld('bp-events',[]),t=ld('bp-todos',[]),m=ld('bp-memos',[]),c=ld('bp-contacts',[]),rr=ld('bp-routines',{});
          setEvents(e);setTodos(t);setMemos(m);setContacts(c);setRoutines(rr);setLoading(false);
          cloudSaveAll(user.uid,{'bp-events':e.filter(ev=>ev.source!=='dooray'),'bp-todos':t,'bp-memos':m,'bp-contacts':c,'bp-routines':rr});
          setCloudSt("synced");
          syncDooray(e);
        }
      }).catch(()=>{
        // Cloud error â†’ fallback to local
        const e=ld('bp-events',[]),t=ld('bp-todos',[]),m=ld('bp-memos',[]),c=ld('bp-contacts',[]);
        setEvents(e);setTodos(t);setMemos(m);setContacts(c);setLoading(false);
        setCloudSt("error");
        syncDooray(e);
      });
    } else {
      // Not logged in â†’ local only
      const e=ld('bp-events',[]),t=ld('bp-todos',[]),m=ld('bp-memos',[]),c=ld('bp-contacts',[]);
      setEvents(e);setTodos(t);setMemos(m);setContacts(c);setLoading(false);
      syncDooray(e);
    }
  },[user,authLoading]);

  // â”€â”€â”€ Cloud: sync on window focus (cross-device) â”€â”€â”€
  useEffect(()=>{
    if(!user||!fbDb) return;
    const handler=async()=>{
      setCloudSt("syncing");
      const cloud=await cloudLoad(user.uid);
      if(cloud){
        if(cloud['bp-events']){const d=cloud['bp-events'];setEvents(d);sv('bp-events',d);}
        if(cloud['bp-todos']){const d=cloud['bp-todos'];setTodos(d);sv('bp-todos',d);}
        if(cloud['bp-memos']){const d=cloud['bp-memos'];setMemos(d);sv('bp-memos',d);}
        if(cloud['bp-contacts']){const d=cloud['bp-contacts'];setContacts(d);sv('bp-contacts',d);}
        if(cloud['bp-routines']){const d=cloud['bp-routines'];setRoutines(d);sv('bp-routines',d);}
        syncDooray(cloud['bp-events']||[]);
      }
      setCloudSt("synced");
    };
    window.addEventListener('focus',handler);
    // Also sync every 30s
    const t=setInterval(handler,30000);
    return()=>{window.removeEventListener('focus',handler);clearInterval(t);};
  },[user,syncDooray]);

  // â”€â”€â”€ Periodic sync (every 60s) â”€â”€â”€
  useEffect(()=>{
    syncRef.current = setInterval(async()=>{
      const e = ld("bp-events",[]);
      await syncDooray(e);
    }, 60000);
    return()=>clearInterval(syncRef.current);
  },[syncDooray]);

  // â”€â”€â”€ Local storage sync (8s) â”€â”€â”€
  useEffect(()=>{const t=setInterval(()=>{const e=ld("bp-events",[]),t2=ld("bp-todos",[]),m=ld("bp-memos",[]),c=ld("bp-contacts",[]);setEvents(e);setTodos(t2);setMemos(m);setContacts(c);},8000);return()=>clearInterval(t);},[]);

  useEffect(()=>{const h=e=>{if(e.key==="Escape"){if(shareItem)setShareItem(null);else if(showSettings)setShowSettings(false);else if(showEF){setShowEF(false);setEditEv(null);}else if(showTF){setShowTF(false);setEditTd(null);}else if(showMF){setShowMF(false);setEditMe(null);}else if(showCF){setShowCF(false);setEditCo(null);}else if(globalSearch){setGlobalSearch(false);setSearch("");}}}; document.addEventListener("keydown",h);return()=>document.removeEventListener("keydown",h);},[shareItem,showSettings,showEF,showTF,showMF,showCF,globalSearch]);

  const persist=useCallback((k,d,s)=>{
    s(d);sv(k,d);
    // Debounced cloud save
    if(user&&fbDb){
      clearTimeout(window._cloudSaveTimeout);
      window._cloudSaveTimeout=setTimeout(()=>{
        setCloudSt("syncing");
        cloudSaveAll(user.uid,{
          'bp-events':ld('bp-events',[]).filter(e=>e.source!=='dooray'),
          'bp-todos':ld('bp-todos',[]),'bp-memos':ld('bp-memos',[]),'bp-contacts':ld('bp-contacts',[]),
          'bp-routines':ld('bp-routines',{})
        }).then(()=>setCloudSt("synced")).catch(()=>setCloudSt("error"));
      },1500);
    }
  },[user]);

  // â”€â”€â”€ Check/uncheck event â”€â”€â”€
  const toggleCheck=useCallback((evId)=>{
    setCheckedEvs(prev=>{
      const next=prev.includes(evId)?prev.filter(id=>id!==evId):[...prev,evId];
      localStorage.setItem("bp-checked-evs",JSON.stringify(next));
      return next;
    });
  },[]);

  // â”€â”€â”€ Routine toggle â”€â”€â”€
  const toggleRoutine=useCallback((date,routineId)=>{
    setRoutines(prev=>{
      const dayData={...prev[date]||{}};
      dayData[routineId]=!dayData[routineId];
      const next={...prev,[date]:dayData};
      sv("bp-routines",next);
      // Cloud save
      if(user&&fbDb){
        clearTimeout(window._routineSaveTimeout);
        window._routineSaveTimeout=setTimeout(()=>{
          cloudSaveAll(user.uid,{'bp-routines':next}).catch(()=>{});
        },1000);
      }
      return next;
    });
  },[user]);

  // â”€â”€â”€ Dedup events by title+date+time â”€â”€â”€
  const dedup=(evList)=>{
    const map=new Map();
    evList.forEach(ev=>{
      const key=`${ev.title?.trim()}|${ev.date}|${ev.time||""}`;
      const existing=map.get(key);
      if(!existing){map.set(key,ev);}
      else{
        // Keep the one with more info (attendees, location, etc.)
        const score=(e)=>(e.attendees?1:0)+(e.location?1:0)+(e.memo?1:0)+(e.company?1:0)+(e.calendarName?1:0);
        if(score(ev)>score(existing)) map.set(key,{...ev,attendees:ev.attendees||existing.attendees});
        else if(existing.attendees||ev.attendees) map.set(key,{...existing,attendees:existing.attendees||ev.attendees});
      }
    });
    return Array.from(map.values());
  };

  // â”€â”€â”€ Event CRUD with Dooray sync â”€â”€â”€
  const saveEv=async(ev)=>{
    const isDooray = ev.source==="dooray";
    const isNew = !editEv;
    
    if(isDooray && ev.doorayId){
      // Update existing Dooray event
      await pushToDooray(ev, "update");
    } else if(!isDooray && !isNew){
      // Update local event - no Dooray action
    }
    
    persist("bp-events", editEv ? events.map(e=>e.id===ev.id?ev:e) : [...events,{...ev,source:ev.source||"local"}], setEvents);
    setShowEF(false);setEditEv(null);
    
    // If new local event, optionally push to Dooray
    if(isNew && !isDooray){
      // Could add a toggle "ë™ê¸°í™”" option here in future
    }
  };
  const delEv=async(id)=>{
    const ev=events.find(e=>e.id===id);
    if(ev?.source==="dooray"&&ev.doorayId){
      await pushToDooray(ev,"delete");
    }
    persist("bp-events",events.filter(e=>e.id!==id),setEvents);setShowEF(false);setEditEv(null);
  };
  const saveTd=td=>{persist("bp-todos",editTd?todos.map(t=>t.id===td.id?td:t):[...todos,td],setTodos);setShowTF(false);setEditTd(null);};
  const delTd=id=>{persist("bp-todos",todos.filter(t=>t.id!==id),setTodos);setShowTF(false);setEditTd(null);};
  const togTd=id=>{persist("bp-todos",todos.map(t=>t.id===id?{...t,completed:!t.completed,completedDate:!t.completed?TODAY:null}:t),setTodos);};
  const saveMe=m=>{persist("bp-memos",editMe?memos.map(e=>e.id===m.id?m:e):[...memos,m],setMemos);setShowMF(false);setEditMe(null);};
  const delMe=id=>{persist("bp-memos",memos.filter(m=>m.id!==id),setMemos);setShowMF(false);setEditMe(null);};
  const saveCo=c=>{persist("bp-contacts",editCo?contacts.map(e=>e.id===c.id?c:e):[...contacts,c],setContacts);setShowCF(false);setEditCo(null);};
  const delCo=id=>{persist("bp-contacts",contacts.filter(c=>c.id!==id),setContacts);setShowCF(false);setEditCo(null);};
  const restoreData=d=>{sv("bp-events",d.events||[]);sv("bp-todos",d.todos||[]);sv("bp-memos",d.memos||[]);sv("bp-contacts",d.contacts||[]);setEvents(d.events||[]);setTodos(d.todos||[]);setMemos(d.memos||[]);setContacts(d.contacts||[]);setShowSettings(false);};

  // â”€â”€â”€ Filters â”€â”€â”€
  const tabSearch=globalSearch?"":search;
  // Helper: is event's end time in the past?
  const isEvPast=(ev)=>{
    const now=new Date();
    if(!ev.date)return false;
    const evDate=pD(ev.endDate||ev.date);
    if(ev.endTime){const[h,m]=(ev.endTime).split(":").map(Number);evDate.setHours(h,m,0,0);}
    else if(ev.time){const[h,m]=(ev.time).split(":").map(Number);evDate.setHours(h,m+30,0,0);}
    else{evDate.setHours(23,59,59);}
    return now>evDate;
  };
  const dayEvs=dedup(events.filter(e=>{
    if(e.date===selDate) return true;
    if(e.endDate && e.date<=selDate && e.endDate>=selDate) return true;
    return false;
  })).sort((a,b)=>(a.time||"").localeCompare(b.time||""));
  // Split into visible (unchecked) and checked
  const dayEvsVisible=dayEvs.filter(e=>!checkedEvs.includes(e.id));
  const dayEvsChecked=dayEvs.filter(e=>checkedEvs.includes(e.id));
  const fTodos=todos.filter(t=>todoFilt==="active"?!t.completed:todoFilt==="completed"?t.completed:true)
    .filter(t=>!tabSearch||t.title.toLowerCase().includes(tabSearch.toLowerCase()))
    .sort((a,b)=>{
      if(todoSort==="priority"){const o={high:0,medium:1,low:2};return(o[a.priority]||1)-(o[b.priority]||1);}
      if(todoSort==="due"){if(!a.dueDate&&!b.dueDate)return 0;if(!a.dueDate)return 1;if(!b.dueDate)return -1;return a.dueDate.localeCompare(b.dueDate);}
      return 0;
    });
  const fMemos=memos.filter(m=>memoFilt!=="all"?m.type===memoFilt:true).filter(m=>!tabSearch||m.title.toLowerCase().includes(tabSearch.toLowerCase())||m.content?.toLowerCase().includes(tabSearch.toLowerCase())).sort((a,b)=>b.date.localeCompare(a.date));
  const upcoming=dedup(events.filter(e=>e.date>TODAY)).sort((a,b)=>a.date.localeCompare(b.date)||(a.time||"").localeCompare(b.time||"")).slice(0,8);
  const selDO=pD(selDate);const dateLbl=`${selDO.getMonth()+1}ì›” ${selDO.getDate()}ì¼ (${DAYS_KR[selDO.getDay()]})`;
  const activeTd=todos.filter(t=>!t.completed).length;

  const gResults=search&&globalSearch?{
    events:events.filter(e=>e.title?.toLowerCase().includes(search.toLowerCase())||e.location?.toLowerCase().includes(search.toLowerCase())),
    todos:todos.filter(t=>t.title.toLowerCase().includes(search.toLowerCase())),
    memos:memos.filter(m=>m.title.toLowerCase().includes(search.toLowerCase())||m.content?.toLowerCase().includes(search.toLowerCase())),
    contacts:contacts.filter(c=>c.name.toLowerCase().includes(search.toLowerCase())||c.company?.toLowerCase().includes(search.toLowerCase())),
  }:null;

  const routineDone=ROUTINES.filter(r=>(routines[TODAY]||{})[r.id]).length;
  const tabItems=[{k:"routine",i:"ğŸ”¥",l:"ë£¨í‹´",badge:routineDone<ROUTINES.length?ROUTINES.length-routineDone:0},{k:"schedule",i:"ğŸ“…",l:"ì¼ì •"},{k:"todo",i:"âœ…",l:"í• ì¼",badge:activeTd},{k:"memo",i:"ğŸ“",l:"ë©”ëª¨"},{k:"contacts",i:"ğŸ‘¥",l:"ì—°ë½ì²˜"},{k:"news",i:"ğŸ“°",l:"ê¸°ì‚¬"},{k:"pubmed",i:"ğŸ”¬",l:"PubMed"}];

  if(authLoading)return(<div style={{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",background:"#F8FAFC"}}>
    <div style={{textAlign:"center"}}><div style={{fontSize:40,marginBottom:10}}>ğŸ“…</div><div style={{color:"#64748B",fontSize:13}}>ì¸ì¦ í™•ì¸ ì¤‘...</div></div></div>);

  // Show login screen if Firebase is configured but not logged in
  if(fbReady&&!user&&!skipLogin)return(<LoginScreen onLogin={login} onSkip={()=>{setSkipLogin(true);localStorage.setItem("bp-skip-login","1");}}/>);

  if(loading)return(<div style={{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",background:"#F8FAFC"}}>
    <div style={{textAlign:"center"}}><div style={{fontSize:40,marginBottom:10}}>ğŸ“…</div><div style={{color:"#64748B",fontSize:13}}>{cloudSt==="syncing"?"í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...":"ë¡œë”© ì¤‘..."}</div></div></div>);

  return(
    <div style={{minHeight:"100vh",background:"#F1F5F9",fontFamily:"'Noto Sans KR','Pretendard',-apple-system,sans-serif",paddingBottom:76}}>
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>

      {/* Header */}
      <div style={{background:"linear-gradient(135deg,#0F172A,#1E293B 60%,#1E3A5F)",color:"#fff",padding:"12px 16px",position:"sticky",top:0,zIndex:100,boxShadow:"0 2px 12px rgba(0,0,0,0.2)"}}>
        <div className="bp-main-content" style={{maxWidth:600,margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <div style={{width:30,height:30,borderRadius:8,background:"linear-gradient(135deg,#3B82F6,#8B5CF6)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:15}}>ğŸ“…</div>
            <div><div style={{fontWeight:800,fontSize:15,letterSpacing:"-0.5px"}}>BizPlanner</div>
              <div style={{fontSize:8,color:"#94A3B8",fontWeight:600,letterSpacing:1.2}}>SMART BUSINESS PLANNER</div></div>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:5}}>
            {/* Dooray Link */}
            <button onClick={()=>syncDooray(events)} style={{border:"none",background:"rgba(62,111,224,0.3)",borderRadius:6,padding:"5px 8px",cursor:"pointer",display:"flex",alignItems:"center",gap:3}}>
              <span style={{fontSize:11}}>ğŸ”—</span>
              <span style={{fontSize:10,color:"#93C5FD",fontWeight:600}}>ë‘ë ˆì´</span>
            </button>
            {/* Cloud Status */}
            {user&&<div style={{display:"flex",alignItems:"center",gap:3,fontSize:9,color:cloudSt==="synced"?"#4ADE80":cloudSt==="syncing"?"#FBBF24":cloudSt==="error"?"#F87171":"#94A3B8",fontWeight:600}}>
              <div style={{width:5,height:5,borderRadius:"50%",background:cloudSt==="synced"?"#4ADE80":cloudSt==="syncing"?"#FBBF24":cloudSt==="error"?"#F87171":"#64748B",animation:cloudSt==="syncing"?"pulse 1s infinite":"none"}}/>
              {cloudSt==="synced"?"â˜ï¸":cloudSt==="syncing"?"â³":"âš ï¸"}
            </div>}
            {/* Sync Status */}
            <div style={{display:"flex",alignItems:"center",gap:3,fontSize:9,color:syncSt==="synced"?"#4ADE80":syncSt==="syncing"?"#FBBF24":syncSt==="error"?"#F87171":"#94A3B8",fontWeight:600}}>
              <div style={{width:5,height:5,borderRadius:"50%",background:syncSt==="synced"?"#4ADE80":syncSt==="syncing"?"#FBBF24":syncSt==="error"?"#F87171":"#64748B",animation:syncSt==="syncing"?"pulse 1s infinite":"none"}}/>
              {syncSt==="synced"?"ë™ê¸°í™”":syncSt==="syncing"?"ë™ê¸°í™”ì¤‘":syncSt==="error"?"ì˜¤ë¥˜":"ëŒ€ê¸°"}
            </div>
            {/* User Avatar or Login */}
            {user?
              <button onClick={logout} style={{border:"none",background:"none",cursor:"pointer",padding:0,display:"flex",alignItems:"center",gap:4}}>
                <img src={user.photoURL||""} style={{width:26,height:26,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.3)"}} alt="" onError={e=>{e.target.style.display="none";}}/>
              </button>
            :fbReady?
              <button onClick={login} style={{border:"none",background:"rgba(255,255,255,0.15)",borderRadius:6,padding:"4px 8px",cursor:"pointer",fontSize:10,color:"#93C5FD",fontWeight:600}}>ë¡œê·¸ì¸</button>
            :null}
            <button onClick={()=>setShowSettings(true)} style={{border:"none",background:"rgba(255,255,255,0.1)",borderRadius:6,padding:"5px 7px",cursor:"pointer",fontSize:13,color:"#94A3B8"}}>âš™ï¸</button>
          </div>
        </div>
      </div>

      <div className="bp-main-content" style={{maxWidth:600,margin:"0 auto",padding:"0 12px"}}>

        {/* Search */}
        <div style={{margin:"10px 0 0",position:"relative"}}>
          <input value={search} onChange={e=>{setSearch(e.target.value);if(e.target.value)setGlobalSearch(true);else setGlobalSearch(false);}}
            placeholder="ğŸ” ì „ì²´ ê²€ìƒ‰" style={{...inpS,background:"#fff",borderRadius:10,paddingRight:40,boxShadow:"0 1px 3px rgba(0,0,0,0.04)"}}/>
          {search&&<button onClick={()=>{setSearch("");setGlobalSearch(false);}} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",border:"none",background:"none",color:"#94A3B8",cursor:"pointer",fontSize:15}}>âœ•</button>}
        </div>

        {/* Global Search Results */}
        {gResults&&(gResults.events.length+gResults.todos.length+gResults.memos.length+gResults.contacts.length)>0&&(
          <div style={{background:"#fff",borderRadius:10,marginTop:6,padding:10,boxShadow:"0 2px 8px rgba(0,0,0,0.06)",maxHeight:260,overflow:"auto"}}>
            <div style={{fontSize:10,fontWeight:700,color:"#94A3B8",marginBottom:6}}>ê²€ìƒ‰ ê²°ê³¼ ({gResults.events.length+gResults.todos.length+gResults.memos.length+gResults.contacts.length}ê±´)</div>
            {gResults.events.map(e=><div key={e.id} onClick={()=>{setEditEv(e);setShowEF(true);setGlobalSearch(false);setSearch("");}} style={searchResultS}>
              <span>ğŸ“…</span><span style={{flex:1,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{e.title}</span><span style={{fontSize:10,color:"#94A3B8",flexShrink:0}}>{e.date}</span></div>)}
            {gResults.todos.map(t=><div key={t.id} onClick={()=>{setEditTd(t);setShowTF(true);setGlobalSearch(false);setSearch("");}} style={searchResultS}>
              <span>âœ…</span><span style={{flex:1,fontWeight:600}}>{t.title}</span></div>)}
            {gResults.memos.map(m=><div key={m.id} onClick={()=>{setEditMe(m);setShowMF(true);setGlobalSearch(false);setSearch("");}} style={searchResultS}>
              <span>{MEMO_T[m.type]?.icon||"ğŸ“"}</span><span style={{flex:1,fontWeight:600}}>{m.title}</span></div>)}
            {gResults.contacts.map(c=><div key={c.id} onClick={()=>{setEditCo(c);setShowCF(true);setGlobalSearch(false);setSearch("");}} style={searchResultS}>
              <span>ğŸ‘¤</span><span style={{flex:1,fontWeight:600}}>{c.name}</span><span style={{fontSize:10,color:"#94A3B8"}}>{c.company}</span></div>)}
          </div>
        )}

        {/* Tab Bar */}
        <div style={{display:"flex",gap:2,background:"#E2E8F0",borderRadius:12,padding:2,margin:"8px 0",overflowX:"auto",WebkitOverflowScrolling:"touch",scrollbarWidth:"none",msOverflowStyle:"none"}}>
          {tabItems.map(t=><button key={t.k} onClick={()=>{setTab(t.k);setSearch("");setGlobalSearch(false);}}
            style={{minWidth:0,flex:"0 0 auto",padding:"7px 10px",borderRadius:10,border:"none",background:tab===t.k?"#fff":"transparent",color:tab===t.k?"#1E293B":"#64748B",
              fontWeight:tab===t.k?700:500,fontSize:11,cursor:"pointer",transition:"all 0.2s",boxShadow:tab===t.k?"0 1px 4px rgba(0,0,0,0.08)":"none",display:"flex",alignItems:"center",justifyContent:"center",gap:2,whiteSpace:"nowrap"}}>
            <span style={{fontSize:12}}>{t.i}</span> {t.l}
            {t.badge>0&&<span style={{background:"#EF4444",color:"#fff",fontSize:8,fontWeight:700,borderRadius:8,padding:"0px 4px",minWidth:12,textAlign:"center"}}>{t.badge}</span>}
          </button>)}
        </div>

        {/* â•â•â• SCHEDULE â•â•â• */}
        {/* â•â•â• ROUTINE â•â•â• */}
        {tab==="routine"&&<RoutineTab routines={routines} onToggle={toggleRoutine} today={TODAY}/>}

        {/* â•â•â• SCHEDULE â•â•â• */}
        {tab==="schedule"&&<>
          <Dashboard events={events} todos={todos}/>
          <CountdownAlarm events={events}/>
          <Calendar currentDate={curDate} selectedDate={selDate} onSelectDate={setSelDate} events={events}
            onMonthChange={d=>{const nd=new Date(curDate);nd.setMonth(nd.getMonth()+d);setCurDate(nd);}}
            onToday={()=>{setCurDate(new Date());setSelDate(TODAY);}}/>
          
          {/* Day Events */}
          <div style={{marginTop:14}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
              <h3 style={{margin:0,fontSize:15,fontWeight:700,color:"#1E293B",wordBreak:"keep-all"}}>{dateLbl}{dayEvs.length>0&&<span style={{fontSize:11,color:"#94A3B8",fontWeight:400}}> ({dayEvsVisible.length}ê±´{dayEvsChecked.length>0?` Â· âœ“${dayEvsChecked.length}`:""}{dayEvs.filter(e=>isEvPast(e)&&!checkedEvs.includes(e.id)).length>0?` Â· ì™„ë£Œ${dayEvs.filter(e=>isEvPast(e)&&!checkedEvs.includes(e.id)).length}`:""})</span>}</h3>
              {dayEvsChecked.length>0&&<button onClick={()=>setShowChecked(!showChecked)} style={{fontSize:10,padding:"3px 8px",borderRadius:6,border:"1px solid #E2E8F0",background:showChecked?"#1E293B":"#F8FAFC",color:showChecked?"#fff":"#64748B",fontWeight:600,cursor:"pointer"}}>
                {showChecked?"âœ“ ìˆ¨ê¸°ê¸°":`âœ“ ${dayEvsChecked.length}ê±´ ë³´ê¸°`}
              </button>}
            </div>
            {dayEvsVisible.length===0&&dayEvsChecked.length===0?<div style={{textAlign:"center",padding:"24px 0",color:"#94A3B8"}}>
              <div style={{fontSize:24,marginBottom:4}}>ğŸŒ¤</div>
              <div style={{fontSize:13}}>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>
              {(()=>{const next=events.filter(e=>e.date>selDate).sort((a,b)=>a.date.localeCompare(b.date))[0];
                return next?<div style={{fontSize:11,marginTop:5,color:"#3B82F6",cursor:"pointer"}} onClick={()=>setSelDate(next.date)}>ë‹¤ìŒ: {next.date} â€” {next.title} â†’</div>:null;})()}
            </div>
            :<>
              {dayEvsVisible.length===0&&<div style={{textAlign:"center",padding:"12px 0",color:"#94A3B8",fontSize:12}}>ëª¨ë“  ì¼ì •ì´ ì²´í¬ë¨</div>}
              <div style={{display:"flex",flexDirection:"column",gap:6}}>
                {dayEvsVisible.map(ev=><EventCard key={ev.id} ev={ev} isPast={isEvPast(ev)} isChecked={false} onToggleCheck={toggleCheck} onEdit={e=>{setEditEv(e);setShowEF(true);}} onShare={setShareItem}/>)}
              </div>
              {/* Checked events (hidden by default) */}
              {showChecked&&dayEvsChecked.length>0&&<>
                <div style={{fontSize:10,fontWeight:700,color:"#94A3B8",margin:"10px 0 4px",display:"flex",alignItems:"center",gap:6}}>
                  <div style={{flex:1,height:1,background:"#E2E8F0"}}/>
                  <span>âœ“ ì²´í¬ëœ ì¼ì • ({dayEvsChecked.length})</span>
                  <div style={{flex:1,height:1,background:"#E2E8F0"}}/>
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:4}}>
                  {dayEvsChecked.map(ev=><EventCard key={ev.id} ev={ev} isPast={isEvPast(ev)} isChecked={true} onToggleCheck={toggleCheck} onEdit={e=>{setEditEv(e);setShowEF(true);}} onShare={setShareItem}/>)}
                </div>
              </>}
            </>}
          </div>

          {/* Upcoming (tomorrow+) */}
          {upcoming.length>0&&<div style={{marginTop:16}}>
            <h3 style={{margin:"0 0 6px",fontSize:14,fontWeight:700,color:"#1E293B"}}>ğŸ“Œ ë‹¤ê°€ì˜¤ëŠ” ì¼ì • (ë‚´ì¼~)</h3>
            <div style={{display:"flex",flexDirection:"column",gap:4}}>
              {upcoming.map(ev=>{const d=pD(ev.date);const isDooray=ev.source==="dooray";const isMulti=ev.endDate&&ev.endDate!==ev.date;return(
                <div key={ev.id+ev.date} onClick={()=>{setSelDate(ev.date);setEditEv(ev);setShowEF(true);}} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:"#fff",borderRadius:10,cursor:"pointer",boxShadow:"0 1px 2px rgba(0,0,0,0.03)"}}>
                  <div style={{width:34,textAlign:"center",flexShrink:0}}>
                    <div style={{fontSize:8,fontWeight:700,color:"#94A3B8"}}>{MONTHS_KR[d.getMonth()]}</div>
                    <div style={{fontSize:15,fontWeight:800,color:"#1E293B"}}>{d.getDate()}</div>
                    <div style={{fontSize:8,color:d.getDay()===0?"#EF4444":d.getDay()===6?"#3B82F6":"#94A3B8"}}>{DAYS_KR[d.getDay()]}</div>
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:12,fontWeight:600,color:"#1E293B",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",wordBreak:"keep-all"}}>{CAT[ev.category]?.i} {ev.title}</div>
                    <div style={{fontSize:10,color:"#94A3B8",display:"flex",gap:4,flexWrap:"wrap",marginTop:1}}>
                      {ev.time&&<span>{ev.time}</span>}
                      {ev.location&&<span>Â· {ev.location}</span>}
                      {isMulti&&<span style={{color:"#3B82F6"}}>~{ev.endDate}</span>}
                    </div>
                    {ev.attendees&&<div style={{fontSize:10,color:"#2563EB",marginTop:1}}>ğŸ‘¥ {ev.attendees}</div>}
                  </div>
                  <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:2,flexShrink:0}}>
                    <div style={{width:6,height:6,borderRadius:"50%",background:isDooray?"#3E6FE0":PRI[ev.priority]?.dot||"#94A3B8"}}/>
                    {isDooray&&<span style={{fontSize:8,color:"#3E6FE0",fontWeight:600}}>D</span>}
                  </div>
                </div>);})}</div></div>}
        </>}

        {/* â•â•â• TODO â•â•â• */}
        {tab==="todo"&&<>
          <div style={{display:"flex",gap:4,marginBottom:8,alignItems:"center",flexWrap:"wrap"}}>
            {[["all","ì „ì²´",todos.length],["active","ì§„í–‰ì¤‘",todos.filter(t=>!t.completed).length],["completed","ì™„ë£Œ",todos.filter(t=>t.completed).length]].map(([k,l,c])=>
              <button key={k} onClick={()=>setTodoFilt(k)} style={{padding:"5px 10px",borderRadius:16,border:todoFilt===k?"2px solid #1E293B":"2px solid #E2E8F0",background:todoFilt===k?"#1E293B":"#fff",color:todoFilt===k?"#fff":"#64748B",fontWeight:600,fontSize:11,cursor:"pointer"}}>{l}({c})</button>)}
            <div style={{flex:1}}/>
            <select value={todoSort} onChange={e=>setTodoSort(e.target.value)} style={{padding:"4px 8px",borderRadius:6,border:"1.5px solid #E2E8F0",fontSize:10,color:"#64748B",background:"#fff"}}>
              <option value="priority">ì¤‘ìš”ë„</option><option value="due">ë§ˆê°ì¼</option>
            </select>
          </div>
          {fTodos.length===0?<div style={{textAlign:"center",padding:"30px 0",color:"#94A3B8"}}><div style={{fontSize:28}}>âœ¨</div><div style={{fontSize:13,marginTop:4}}>{todoFilt==="completed"?"ì™„ë£Œ í•­ëª© ì—†ìŒ":"í•  ì¼ ì—†ìŒ"}</div></div>
          :<div style={{display:"flex",flexDirection:"column",gap:6}}>
            {fTodos.map(td=>{const p=PRI[td.priority];const days=dBtw(td.createdDate,TODAY);const work=td.completed&&td.completedDate?dBtw(td.createdDate,td.completedDate):null;
              const overdue=!td.completed&&td.dueDate&&td.dueDate<TODAY;const dueSoon=!td.completed&&td.dueDate&&!overdue&&dBtw(TODAY,td.dueDate)<=2;
              return(<div key={td.id} style={{background:"#fff",borderRadius:10,padding:"10px 12px",borderLeft:`4px solid ${td.completed?"#10B981":overdue?"#EF4444":p.dot}`,boxShadow:"0 1px 3px rgba(0,0,0,0.04)",opacity:td.completed?0.7:1}}>
                <div style={{display:"flex",alignItems:"center",gap:8}}>
                  <button onClick={()=>togTd(td.id)} style={{width:20,height:20,borderRadius:5,border:`2px solid ${td.completed?"#10B981":"#CBD5E1"}`,background:td.completed?"#10B981":"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:11,flexShrink:0}}>{td.completed&&"âœ“"}</button>
                  <div style={{flex:1,cursor:"pointer",minWidth:0}} onClick={()=>{setEditTd(td);setShowTF(true);}}>
                    <div style={{fontSize:13,fontWeight:600,color:td.completed?"#94A3B8":"#1E293B",textDecoration:td.completed?"line-through":"none",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",wordBreak:"keep-all"}}>{td.title}</div>
                    <div style={{display:"flex",gap:4,marginTop:2,flexWrap:"wrap",alignItems:"center"}}>
                      <span style={{fontSize:9,background:p.bg,color:p.text,borderRadius:3,padding:"0px 4px",fontWeight:600}}>{p.label}</span>
                      <span style={{fontSize:9,color:"#94A3B8"}}>{td.category}</span>
                      {!td.completed&&<span style={{fontSize:9,color:days>7?"#EF4444":"#64748B"}}>â±{days}ì¼</span>}
                      {work!==null&&<span style={{fontSize:9,color:"#10B981"}}>âœ…{work}ì¼</span>}
                      {td.dueDate&&!td.completed&&<span style={{fontSize:9,color:overdue?"#EF4444":dueSoon?"#F97316":"#64748B",fontWeight:overdue||dueSoon?700:400}}>
                        {overdue?`ğŸš¨${Math.abs(dBtw(td.dueDate,TODAY))}ì¼ì´ˆê³¼`:`D-${dBtw(TODAY,td.dueDate)}`}</span>}
                    </div>
                  </div>
                </div>
              </div>);})}</div>}
          {todos.length>0&&<div style={{marginTop:14,background:"#fff",borderRadius:12,padding:12,boxShadow:"0 1px 3px rgba(0,0,0,0.04)"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
              <div style={{fontSize:12,fontWeight:700,color:"#1E293B"}}>ğŸ“Š í†µê³„</div>
              {todos.filter(t=>t.completed).length>0&&<button onClick={()=>{if(confirm(`ì™„ë£Œ ${todos.filter(t=>t.completed).length}ê°œ ì‚­ì œ?`))persist("bp-todos",todos.filter(t=>!t.completed),setTodos);}} style={{fontSize:10,padding:"3px 8px",borderRadius:5,border:"1px solid #FECACA",background:"#FEF2F2",color:"#DC2626",fontWeight:600,cursor:"pointer"}}>ğŸ—‘ ì™„ë£Œì‚­ì œ</button>}
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6}}>
              {[{l:"ì „ì²´",v:todos.length,c:"#3B82F6"},{l:"ì™„ë£Œìœ¨",v:`${todos.length>0?Math.round(todos.filter(t=>t.completed).length/todos.length*100):0}%`,c:"#10B981"},
                {l:"í‰ê· ì†Œìš”",v:(()=>{const cd=todos.filter(t=>t.completed&&t.completedDate);return cd.length?`${Math.round(cd.reduce((s,t)=>s+dBtw(t.createdDate,t.completedDate),0)/cd.length)}ì¼`:"-";})(),c:"#F59E0B"},
                {l:"ì´ˆê³¼",v:todos.filter(t=>!t.completed&&t.dueDate&&t.dueDate<TODAY).length,c:"#EF4444"},
              ].map(s=><div key={s.l} style={{textAlign:"center"}}><div style={{fontSize:18,fontWeight:800,color:s.c}}>{s.v}</div><div style={{fontSize:9,color:"#94A3B8"}}>{s.l}</div></div>)}
            </div>
          </div>}
        </>}

        {/* â•â•â• MEMO â•â•â• */}
        {tab==="memo"&&<>
          <div style={{display:"flex",gap:4,marginBottom:10,flexWrap:"wrap"}}>
            <button onClick={()=>setMemoFilt("all")} style={{padding:"4px 8px",borderRadius:16,border:memoFilt==="all"?"2px solid #1E293B":"2px solid #E2E8F0",background:memoFilt==="all"?"#1E293B":"#fff",color:memoFilt==="all"?"#fff":"#64748B",fontWeight:600,fontSize:10,cursor:"pointer"}}>ì „ì²´</button>
            {Object.entries(MEMO_T).map(([k,v])=><button key={k} onClick={()=>setMemoFilt(k)} style={{padding:"4px 8px",borderRadius:16,border:memoFilt===k?`2px solid ${v.color}`:"2px solid #E2E8F0",background:memoFilt===k?v.color+"18":"#fff",color:memoFilt===k?v.color:"#64748B",fontWeight:600,fontSize:10,cursor:"pointer"}}>{v.icon} {v.label}</button>)}
          </div>
          {fMemos.length===0?<div style={{textAlign:"center",padding:"30px 0",color:"#94A3B8"}}><div style={{fontSize:28}}>ğŸ“</div><div style={{fontSize:13,marginTop:4}}>ë©”ëª¨ ì—†ìŒ</div></div>
          :<div style={{display:"flex",flexDirection:"column",gap:6}}>
            {fMemos.map(m=>{const mt=MEMO_T[m.type]||MEMO_T.free;return(
              <div key={m.id} onClick={()=>{setEditMe(m);setShowMF(true);}} style={{background:"#fff",borderRadius:10,padding:"10px 12px",borderLeft:`4px solid ${mt.color}`,boxShadow:"0 1px 3px rgba(0,0,0,0.04)",cursor:"pointer"}}>
                <div style={{display:"flex",alignItems:"center",gap:4,marginBottom:2}}>
                  <span style={{fontSize:12}}>{mt.icon}</span>
                  <span style={{fontSize:8,background:mt.color+"20",color:mt.color,borderRadius:3,padding:"0px 4px",fontWeight:700}}>{mt.label}</span>
                  <span style={{fontWeight:600,fontSize:13,color:"#1E293B",flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",wordBreak:"keep-all"}}>{m.title}</span>
                  <span style={{fontSize:10,color:"#94A3B8",flexShrink:0}}>{m.date}</span>
                </div>
                {m.content&&<div style={{fontSize:11,color:"#64748B",marginLeft:18,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{m.content}</div>}
                {m.decisions&&<div style={{fontSize:10,color:"#059669",marginLeft:18,marginTop:1}}>âœ… {m.decisions.substring(0,40)}{m.decisions.length>40?"...":""}</div>}
              </div>);})}</div>}
        </>}

        {/* â•â•â• CONTACTS â•â•â• */}
        {tab==="contacts"&&<>
          {contacts.filter(c=>!tabSearch||c.name.toLowerCase().includes(tabSearch.toLowerCase())||c.company?.toLowerCase().includes(tabSearch.toLowerCase())).length===0
            ?<div style={{textAlign:"center",padding:"30px 0",color:"#94A3B8"}}><div style={{fontSize:28}}>ğŸ‘¥</div><div style={{fontSize:13,marginTop:4}}>ì—°ë½ì²˜ ì—†ìŒ</div></div>
            :<>
            <div style={{fontSize:11,color:"#94A3B8",fontWeight:600,marginBottom:6}}>ì´ {contacts.filter(c=>!tabSearch||c.name.toLowerCase().includes(tabSearch.toLowerCase())||c.company?.toLowerCase().includes(tabSearch.toLowerCase())).length}ëª…</div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              {contacts.filter(c=>!tabSearch||c.name.toLowerCase().includes(tabSearch.toLowerCase())||c.company?.toLowerCase().includes(tabSearch.toLowerCase())).sort((a,b)=>a.name.localeCompare(b.name)).map(c=>
                <div key={c.id} onClick={()=>{setEditCo(c);setShowCF(true);}} style={{background:"#fff",borderRadius:10,padding:"10px 12px",boxShadow:"0 1px 3px rgba(0,0,0,0.04)",cursor:"pointer",display:"flex",alignItems:"center",gap:10}}>
                  <div style={{width:34,height:34,borderRadius:8,background:"linear-gradient(135deg,#6366F1,#8B5CF6)",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontWeight:700,fontSize:14,flexShrink:0}}>{c.name.charAt(0)}</div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:13,fontWeight:600,color:"#1E293B",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{c.name}{c.position&&<span style={{fontSize:10,color:"#94A3B8",fontWeight:400}}> {c.position}</span>}</div>
                    <div style={{fontSize:11,color:"#64748B",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{c.company&&`ğŸ¢ ${c.company}`}{c.phone&&` ğŸ“± ${c.phone}`}</div>
                  </div>
                  <div style={{display:"flex",gap:3,flexShrink:0}}>
                    {c.phone&&<a href={`tel:${c.phone}`} onClick={e=>e.stopPropagation()} style={{padding:"4px 7px",borderRadius:6,background:"#DBEAFE",fontSize:11,color:"#2563EB",textDecoration:"none"}}>ğŸ“</a>}
                    {c.email&&<a href={`mailto:${c.email}`} onClick={e=>e.stopPropagation()} style={{padding:"4px 7px",borderRadius:6,background:"#F0FDF4",fontSize:11,color:"#059669",textDecoration:"none"}}>ğŸ“§</a>}
                  </div>
                </div>)}</div>
            </>}
        </>}

        {/* â•â•â• NEWS â•â•â• */}
        {tab==="news"&&<NewsTab/>}

        {/* â•â•â• PUBMED â•â•â• */}
        {tab==="pubmed"&&<PubMedTab/>}
      </div>

      {/* FAB - only show for schedule/todo/memo/contacts */}
      {["schedule","todo","memo","contacts"].includes(tab)&&<button onClick={()=>{if(tab==="schedule"){setEditEv(null);setShowEF(true);}else if(tab==="todo"){setEditTd(null);setShowTF(true);}else if(tab==="memo"){setEditMe(null);setShowMF(true);}else{setEditCo(null);setShowCF(true);}}}
        style={{position:"fixed",bottom:20,right:20,width:52,height:52,borderRadius:"50%",border:"none",background:"linear-gradient(135deg,#3B82F6,#6366F1)",color:"#fff",fontSize:26,cursor:"pointer",boxShadow:"0 4px 20px rgba(59,130,246,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:90}}>+</button>}

      {/* Modals */}
      {showEF&&<EventForm event={editEv} onSave={saveEv} onClose={()=>{setShowEF(false);setEditEv(null);}} onDelete={delEv} contacts={contacts} selectedDate={selDate} onAddContact={()=>{setShowEF(false);setEditCo(null);setShowCF(true);}}/>}
      {showTF&&<TodoForm todo={editTd} onSave={saveTd} onClose={()=>{setShowTF(false);setEditTd(null);}} onDelete={delTd}/>}
      {showMF&&<MemoForm memo={editMe} onSave={saveMe} onClose={()=>{setShowMF(false);setEditMe(null);}} onDelete={delMe}/>}
      {showCF&&<ContactForm contact={editCo} onSave={saveCo} onClose={()=>{setShowCF(false);setEditCo(null);}} onDelete={delCo}/>}
      {shareItem&&<ShareModal item={shareItem} onClose={()=>setShareItem(null)}/>}
      {showSettings&&<SettingsModal onClose={()=>setShowSettings(false)} events={events} todos={todos} memos={memos} contacts={contacts} onRestore={restoreData} doorayStatus={doorayStatus} onDooraySync={()=>syncDooray(events)} user={user} cloudSt={cloudSt} onLogin={login} onLogout={logout} fbReady={fbReady}/>}

      <style>{`
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        input,select,textarea,button{font-family:'Noto Sans KR',sans-serif}
        ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px}
        /* Hide scrollbar on tab bar */
        div::-webkit-scrollbar{height:0;width:0}
        @media(max-width:480px){input,textarea,select{font-size:16px!important}}
        /* Tablet 10-12 inch */
        @media(min-width:768px){
          .bp-main-content{max-width:720px!important}
        }
        /* Notebook */
        @media(min-width:1024px){
          .bp-main-content{max-width:800px!important}
        }
        @media(min-width:1280px){
          .bp-main-content{max-width:900px!important}
        }
      `}</style>
    </div>
  );
}

// â”€â”€â”€ Styles â”€â”€â”€
const inpS={width:"100%",padding:"9px 12px",borderRadius:8,border:"1.5px solid #E2E8F0",fontSize:14,color:"#1E293B",outline:"none",background:"#F8FAFC",transition:"border-color 0.2s"};
const labS={display:"block",fontSize:10,fontWeight:600,color:"#64748B",marginBottom:2};
const btnS={padding:"9px 16px",borderRadius:8,border:"none",fontWeight:600,fontSize:13,cursor:"pointer",transition:"all 0.15s"};
const closeS={border:"none",background:"none",fontSize:18,cursor:"pointer",color:"#94A3B8",padding:4};
const navS={border:"none",background:"#F1F5F9",borderRadius:7,width:30,height:30,cursor:"pointer",fontSize:13,color:"#475569",display:"flex",alignItems:"center",justifyContent:"center"};
const modalOverlay={position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",backdropFilter:"blur(4px)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:200,padding:12};
const modalCont={background:"#fff",borderRadius:18,padding:20,width:"100%",maxWidth:440,maxHeight:"88vh",overflow:"auto",boxShadow:"0 20px 60px rgba(0,0,0,0.25)"};
const attachBtnS={padding:"6px 10px",borderRadius:6,border:"2px dashed #CBD5E1",background:"#fff",color:"#64748B",fontSize:10,fontWeight:600,cursor:"pointer"};
const searchResultS={display:"flex",alignItems:"center",gap:6,padding:"7px 8px",cursor:"pointer",borderRadius:6,fontSize:12,color:"#1E293B",borderBottom:"1px solid #F8FAFC",transition:"background 0.12s"};

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(BizPlanner));
  </script>
</body>
</html>
